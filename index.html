<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מתורגמן חכם - עובד-מנהל</title>

    <!-- Tailwind CSS CDN - משמש לעיצוב מהיר ומודרני -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* פונט Heebo מתאים לעברית ולמראה נקי */
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap');
        /* פונט לתאית */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap');
    </style>

    <!-- simple-keyboard CSS CDN - עבור המקלדת הווירטואלית -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/css/index.css">

    <style>
        /* הגדרות פונט וריסט כלליות לגוף הדף */
        body {
            font-family: 'Heebo', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* רקע כחול-לבן עם הדרגתיות */
            background: linear-gradient(135deg, #e0f2fe 0%, #bbdefb 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px; /* הגדל פדינג כללי */
            gap: 32px; /* מרווח גדול יותר בין סקשנים */
        }

        /* הסתרת נגן האודיו המובנה של הדפדפן */
        audio {
            display: none;
        }

        /* עיצוב זכוכית (Glassmorphism) לפאנלים ולחלק מהכפתורים */
        .glass-panel {
            background-color: rgba(255, 255, 255, 0.6); /* רקע לבן שקוף */
            backdrop-filter: blur(10px); /* אפקט טשטוש */
            border: 1px solid rgba(255, 255, 255, 0.3); /* גבול שקוף */
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); /* צל עדין */
            border-radius: 20px; /* פינות עגולות יותר */
        }

        /* הגדרות בסיסיות של simple-keyboard כדי להתאים לעיצוב הכללי של Tailwind */
        .simple-keyboard {
            @apply glass-panel p-6 max-w-4xl mx-auto;
        }
        .simple-keyboard .hg-button {
            @apply rounded-xl text-lg font-medium text-gray-800 bg-gray-100 hover:bg-gray-200 active:bg-gray-300 transition-all duration-150;
            padding: 0.8rem 0.5rem;
        }
        .simple-keyboard .hg-button.hg-standardBtn {
            @apply h-14;
        }
        .simple-keyboard .hg-button.hg-functionBtn {
            @apply bg-blue-500 text-white hover:bg-blue-600;
        }
        .simple-keyboard .hg-button.hg-button-space {
            @apply w-full;
        }
        .simple-keyboard .hg-button-shift,
        .simple-keyboard .hg-button-capslock,
        .simple-keyboard .hg-button-tab,
        .simple-keyboard .hg-button-bksp {
            @apply bg-gray-300 text-gray-800 hover:bg-gray-400;
        }
        .simple-keyboard .hg-button-shift:active,
        .simple-keyboard .hg-button-capslock:active {
            @apply bg-gray-500;
        }
        .simple-keyboard .hg-row .hg-button {
            line-height: normal;
        }

        /* אנימציית הבהוב עבור הפופאפ - מושך תשומת לב */
        @keyframes pulse-once {
            0% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 rgba(0, 0, 0, 0); }
            50% { transform: scale(1.02); opacity: 1; box-shadow: 0 0 20px rgba(0, 0, 0, 0.4); }
            100% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 rgba(0, 0, 0, 0); }
        }

        @keyframes urgent-pulse {
            0% { background-color: rgba(255, 99, 71, 0.7); box-shadow: 0 0 15px rgba(255, 99, 71, 0.8); }
            50% { background-color: rgba(255, 140, 0, 0.7); box-shadow: 0 0 30px rgba(255, 140, 0, 0.8); }
            100% { background-color: rgba(255, 99, 71, 0.7); box-shadow: 0 0 15px rgba(255, 99, 71, 0.8); }
        }

        .popup-animate {
            animation: pulse-once 1.5s ease-out forwards;
        }
        .urgent-popup-animate {
            animation: urgent-pulse 1s infinite alternate; /* אנימציה מתחלפת ואגרסיבית יותר */
        }

        /* אנימציית ברק וקשת צבעים למשפט מתורגם מיידי */
        @keyframes rainbow-glow {
            0% { border-color: #ff0000; box-shadow: 0 0 15px #ff0000; }
            16% { border-color: #ff7f00; box-shadow: 0 0 15px #ff7f00; }
            33% { border-color: #ffff00; box-shadow: 0 0 15px #ffff00; }
            50% { border-color: #00ff00; box-shadow: 0 0 15px #00ff00; }
            66% { border-color: #0000ff; box-shadow: 0 0 15px #0000ff; }
            83% { border-color: #4b0082; box-shadow: 0 0 15px #4b0082; }
            100% { border-color: #9400d3; box-shadow: 0 0 15px #9400d3; }
        }

        .rainbow-border {
            border: 4px solid; /* עבה יותר בשביל האפקט */
            animation: rainbow-glow 3s infinite alternate; /* אנימציה אינסופית ומתחלפת */
        }
        
        /* אפקט הקלדה */
        .typing-effect::after {
            content: '|';
            animation: blink-caret .75s step-end infinite;
        }

        @keyframes blink-caret {
            from, to { border-right-color: transparent }
            50% { border-right-color: black; }
        }

        /* פונט עבור טקסט תאית */
        .thai-text {
            font-family: 'Noto Sans Thai', sans-serif;
        }

        /* התאמה לרספונסיביות של המקלדת */
        @media (max-width: 768px) {
            .simple-keyboard .hg-button {
                font-size: 0.9em;
                padding: 0.5rem 0.3rem;
            }
            .simple-keyboard .hg-button.hg-standardBtn {
                height: 3.5rem; /* גובה קטן יותר למסכים קטנים */
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-white min-h-screen flex flex-col items-center p-6 space-y-8">

    <div class="w-full max-w-7xl flex flex-wrap lg:flex-nowrap justify-center gap-8">
        <!-- פאנל עובד תאילנדי - בקשות למנהל -->
        <div class="glass-panel p-8 flex-1 flex flex-col items-center min-w-[320px] lg:min-w-[45%] bg-green-50/50">
            <h2 class="text-3xl font-bold text-green-700 mb-6">עובד תאילנדי (בקשות למנהל)</h2>
            <div id="thaiWorkerPanel" class="grid grid-cols-2 md:grid-cols-3 gap-5 w-full">
                <!-- כפתורים ייווצרו כאן באופן דינמי באמצעות JavaScript -->
            </div>
        </div>

        <!-- פאנל מנהל - הוראות לעובד -->
        <div class="glass-panel p-8 flex-1 flex flex-col items-center min-w-[320px] lg:min-w-[45%] bg-blue-50/50">
            <h2 class="text-3xl font-bold text-blue-700 mb-6">מנהל (הוראות לעובד)</h2>
            <div id="managerPanel" class="grid grid-cols-2 md:grid-cols-3 gap-5 w-full">
                <!-- כפתורים ייווצרו כאן באופן דינמי באמצעות JavaScript -->
            </div>
        </div>
    </div>

    <!-- פאנל משפטי תרגום מיידי -->
    <div class="glass-panel p-8 w-full max-w-7xl flex flex-col items-center">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">משפטי תרגום מיידי</h2>
        <div class="flex flex-wrap justify-center gap-4 mb-8 w-full">
            <!-- כפתורים למשפטים בעברית -->
            <div class="flex flex-col items-center w-full md:w-1/2 lg:w-2/5">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">עברית לתאית</h3>
                <div id="instantPhrasesHe" class="grid grid-cols-1 gap-4 w-full">
                    <!-- כפתורי משפטים ייווצרו כאן -->
                </div>
            </div>
            <!-- כפתורים למשפטים בתאית -->
            <div class="flex flex-col items-center w-full md:w-1/2 lg:w-2/5">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">תאית לעברית</h3>
                <div id="instantPhrasesTh" class="grid grid-cols-1 gap-4 w-full">
                    <!-- כפתורי משפטים ייווצרו כאן -->
                </div>
            </div>
             <!-- כפתורי מספרים 1-10 בעברית -->
            <div class="flex flex-col items-center w-full md:w-1/2 lg:w-2/5 mt-8">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">מספרים (עברית לתאית)</h3>
                <div id="numberPhrasesHe" class="grid grid-cols-2 gap-4 w-full">
                    <!-- כפתורי מספרים ייווצרו כאן -->
                </div>
            </div>
            <!-- כפתורי מספרים 1-10 בתאית -->
            <div class="flex flex-col items-center w-full md:w-1/2 lg:w-2/5 mt-8">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">ตัวเลข (תאית לעברית)</h3>
                <div id="numberPhrasesTh" class="grid grid-cols-2 gap-4 w-full">
                    <!-- כפתורי מספרים ייווצרו כאן -->
                </div>
            </div>
        </div>
        <!-- אזור להצגת המשפט המתורגם המיידי -->
        <div id="instantTranslationOutput" class="mt-8 p-6 text-2xl font-bold text-gray-900 bg-gray-50 rounded-2xl border-4 border-transparent min-h-[100px] flex items-center justify-center w-full max-w-2xl text-center shadow-lg transition-all duration-300">
            המשפט המתורגם יופיע כאן
        </div>
    </div>

    <!-- פאנל תרגום וכתיבה חופשית -->
    <div class="glass-panel p-8 w-full max-w-7xl flex flex-col items-center">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">תרגום וכתיבה חופשית</h2>
        <textarea id="freeTextInput" placeholder="הקלד כאן טקסט בעברית או בתאית..." rows="4"
                  class="w-full p-4 mb-6 text-xl border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition-all resize-y shadow-sm"></textarea>
        <div class="flex flex-wrap justify-center gap-4 mb-8 w-full">
            <button id="setLangHe" class="px-8 py-4 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition-all text-xl">
                הקלד בעברית
            </button>
            <button id="setLangTh" class="px-8 py-4 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition-all text-xl thai-text">
                พิมพ์ภาษาไทย
            </button>
            <button id="speakTranslated" class="px-8 py-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-all text-xl">
                השמע טקסט מתורגם
            </button>
        </div>
        <div class="simple-keyboard w-full"></div>
    </div>

    <!-- חלון פופאפ (Popup) - שכבת על נסתרת שתופיע בלחיצה על כפתור -->
    <div id="popupOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div id="popupContent" class="glass-panel p-10 flex flex-col items-center justify-center max-w-lg w-11/12 transform scale-0 opacity-0 transition-all duration-300 ease-out relative">
            <p id="popupText" class="text-4xl font-bold text-center mb-8 text-gray-800"></p>
            <button id="popupReplayButton" class="px-8 py-4 bg-purple-600 text-white font-semibold rounded-full shadow-lg hover:bg-purple-700 transition-all duration-200 text-2xl">
                🔊 השמע שוב
            </button>
            <button id="popupCloseButton" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-3xl font-bold">
                &times;
            </button>
            <span id="urgentIcon" class="absolute top-4 left-4 text-5xl hidden">🔔</span>
        </div>
    </div>

    <!-- simple-keyboard JS CDN - עבור המקלדת הווירטואלית -->
    <script src="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/index.js"></script>

    <script>
        // כתובת שרת הפלאסק שלך - וודא שהשרת רץ על פורט 5000
        const SERVER_URL = 'http://localhost:5000';

        let currentAudio = null; // משתנה לשמירה על נגן האודיו הנוכחי

        // אלמנטים של הפופאפ ב-HTML
        const popupOverlay = document.getElementById('popupOverlay');
        const popupContent = document.getElementById('popupContent');
        const popupText = document.getElementById('popupText');
        const popupReplayButton = document.getElementById('popupReplayButton');
        const popupCloseButton = document.getElementById('popupCloseButton');
        const urgentIcon = document.getElementById('urgentIcon'); // אייקון התראה
        let popupAudioUrl = ''; // ישמור את ה-URL של האודיו שהושמע בפופאפ
        let popupCloseTimeout; // משתנה לשמירת הטיים-אאוט של סגירת הפופאפ אוטומטית

        // אלמנטים של תרגום מיידי
        const instantTranslationOutput = document.getElementById('instantTranslationOutput');

        // הגדרות מקלדת וירטואלית SimpleKeyboard
        let keyboard;
        let currentKeyboardLayout = 'hebrew'; // ברירת מחדל: עברית

        // פריסות מקלדת עבור עברית ותאית (דוגמאות בסיסיות)
        const layoutOptions = {
            'hebrew': {
                default: [
                    "` 1 2 3 4 5 6 7 8 9 0 - = {bksp}",
                    "{tab} / ' ק ר ו ן ט צ ש ד ג כ ע ח י ל ף ,",
                    "{capslock} ז ס ב ה נ מ ך ף , . / \\",
                    "{shift} ת א ד ה ב ג ו ח ז ל ט ר נ מ {shift}",
                    "{space}"
                ],
                shift: [
                    "~ ! @ # $ % ^ & * ( ) _ + {bksp}",
                    "{tab} Q W E R T Y U I O P { } |",
                    "{capslock} A S D F G H J K L : \"",
                    "{shift} Z X C V B N M < > ? {shift}",
                    "{space}"
                ]
            },
            'thai': {
                default: [
                    "ๅ / - ภ ถุ ู กึ หิ ่ ้ ็ ื {bksp}",
                    "{tab} พั รน ะ ตร ยบ ุย อิ โ โอ ป ก ฬ",
                    "{capslock} า ส ด ฟ แ ะั ห โ ค ช",
                    "{shift} ซษ มอ ดบ น เ ท จ ก ็ {shift}",
                    "{space}"
                ],
                shift: [
                    "+ ๑ ๒ ๓ ๔ ๕ ๖ ๗ ๘ ๙ ๐ ฯ ญ ฏ {bksp}",
                    "{tab} ฎ ฑ ธ ํ ๊ ณ ม ย ณบ ุุ ณข ณค ณง {tab}",
                    "{capslock} ฟะ หะ กะ ดะ สั ะั น ะร ะล ะอ ะใ {capslock}",
                    "{shift} ะม ะน ะว ะอ ะร ะส ะฟ ะง ะจ ะค ะล {shift}",
                    "{space}"
                ]
            }
        };

        // מאגר קבצי אודיו בפורמט Base64
        // חשוב: אלו הם קבצי דמה. עליך להחליף את ה-Base64 בקבצי אודיו אמיתיים משלך.
        // תוכל להשתמש בכלים מקוונים או סקריפטים כדי להמיר קבצי MP3/WAV ל-Base64.
        // דוגמה: he_break_1 הוא אודיו ל"אני רוצה הפסקה."
        const base64AudioData = {
            "he_break_1": "data:audio/mpeg;base64,TBD_HE_BREAK_1_BASE64_AUDIO_HERE", // לדוגמה, קובץ אודיו ב-Base64 עבור "אני רוצה הפסקה."
            "th_break_1": "data:audio/mpeg;base64,TBD_TH_BREAK_1_BASE64_AUDIO_HERE", // לדוגמה, קובץ אודיו ב-Base64 עבור "ผม/ฉัน ขอพัก"
            "he_toilet_1": "data:audio/mpeg;base64,TBD_HE_TOILET_1_BASE64_AUDIO_HERE",
            "th_toilet_1": "data:audio/mpeg;base64,TBD_TH_TOILET_1_BASE64_AUDIO_HERE",
            "he_help_1": "data:audio/mpeg;base64,TBD_HE_HELP_1_BASE64_AUDIO_HERE",
            "th_help_1": "data:audio/mpeg;base64,TBD_TH_HELP_1_BASE64_AUDIO_HERE",
            "he_sick_1": "data:audio/mpeg;base64,TBD_HE_SICK_1_BASE64_AUDIO_HERE",
            "th_sick_1": "data:audio/mpeg;base64,TBD_TH_SICK_1_BASE64_AUDIO_HERE",
            "he_load_cement_1": "data:audio/mpeg;base64,TBD_HE_LOAD_CEMENT_1_BASE64_AUDIO_HERE",
            "th_load_cement_1": "data:audio/mpeg;base64,TBD_TH_LOAD_CEMENT_1_BASE64_AUDIO_HERE",
            "he_load_bags_1": "data:audio/mpeg;base64,TBD_HE_LOAD_BAGS_1_BASE64_AUDIO_HERE",
            "th_load_bags_1": "data:audio/mpeg;base64,TBD_TH_LOAD_BAGS_1_BASE64_AUDIO_HERE",
            "he_help_alaa_1": "data:audio/mpeg;base64,TBD_HE_HELP_ALAA_1_BASE64_AUDIO_HERE",
            "th_help_alaa_1": "data:audio/mpeg;base64,TBD_TH_HELP_ALAA_1_BASE64_AUDIO_HERE",
            "he_help_adham_1": "data:audio/mpeg;base64,TBD_HE_HELP_ADHAM_1_BASE64_AUDIO_HERE",
            "th_help_adham_1": "data:audio/mpeg;base64,TBD_TH_HELP_ADHAM_1_BASE64_AUDIO_HERE",
            "he_help_store_1": "data:audio/mpeg;base64,TBD_HE_HELP_STORE_1_BASE64_AUDIO_HERE",
            "th_help_store_1": "data:audio/mpeg;base64,TBD_TH_HELP_STORE_1_BASE64_AUDIO_HERE",
            "he_next_product_1": "data:audio/mpeg;base64,TBD_HE_NEXT_PRODUCT_1_BASE64_AUDIO_HERE",
            "th_next_product_1": "data:audio/mpeg;base64,TBD_TH_NEXT_PRODUCT_1_BASE64_AUDIO_HERE",
            "he_good_morning_1": "data:audio/mpeg;base64,TBD_HE_GOOD_MORNING_1_BASE64_AUDIO_HERE",
            "th_good_morning_1": "data:audio/mpeg;base64,TBD_TH_GOOD_MORNING_1_BASE64_AUDIO_HERE",
            "he_good_evening_1": "data:audio/mpeg;base64,TBD_HE_GOOD_EVENING_1_BASE64_AUDIO_HERE",
            "th_good_evening_1": "data:audio/mpeg;base64,TBD_TH_GOOD_EVENING_1_BASE64_AUDIO_HERE",
            "he_how_are_you_1": "data:audio/mpeg;base64,TBD_HE_HOW_ARE_YOU_1_BASE64_AUDIO_HERE",
            "th_how_are_you_1": "data:audio/mpeg;base64,TBD_TH_HOW_ARE_YOU_1_BASE64_AUDIO_HERE",
            "he_how_do_you_feel_1": "data:audio/mpeg;base64,TBD_HE_HOW_DO_YOU_FEEL_1_BASE64_AUDIO_HERE",
            "th_how_do_you_feel_1": "data:audio/mpeg;base64,TBD_TH_HOW_DO_YOU_FEEL_1_BASE64_AUDIO_HERE",
            "he_come_help_loading_1": "data:audio/mpeg;base64,TBD_HE_COME_HELP_LOADING_1_BASE64_AUDIO_HERE",
            "th_come_help_loading_1": "data:audio/mpeg;base64,TBD_TH_COME_HELP_LOADING_1_BASE64_AUDIO_HERE"
        };


        // מאגר המשפטים הראשי עבור כפתורי הפאנלים
        const phrasesData = [
          { "id": "thai_break_request_1", "display_text": "הפסקה", "icon": "☕", "he_text": "אני רוצה הפסקה.", "th_text": "ผม/ฉัน ขอพัก", "he_audio_id": "he_break_1", "th_audio_id": "th_break_1", "panel": "thai_worker", "is_urgent": false },
          { "id": "thai_toilet_request_1", "display_text": "שירותים", "icon": "🚽", "he_text": "אני צריך לשירותים.", "th_text": "ผม/ฉัน ต้องการไปห้องน้ำ", "he_audio_id": "he_toilet_1", "th_audio_id": "th_toilet_1", "panel": "thai_worker", "is_urgent": false },
          { "id": "thai_help_request_1", "display_text": "עזרה", "icon": "✋", "he_text": "אני צריך עזרה.", "th_text": "ผม/ฉัน ต้องการความช่วยเหลือ", "he_audio_id": "he_help_1", "th_audio_id": "th_help_1", "panel": "thai_worker", "is_urgent": true },
          { "id": "thai_sick_request_1", "display_text": "חולה", "icon": "😷", "he_text": "אני מרגיש חולה.", "th_text": "ผม/ฉัน รู้สึกไม่สบาย", "he_audio_id": "he_sick_1", "th_audio_id": "th_sick_1", "panel": "thai_worker", "is_urgent": true },
          { "id": "thai_good_morning_1", "display_text": "בוקר טוב", "icon": "☀️", "he_text": "בוקר טוב.", "th_text": "สวัสดีตอนเช้า", "he_audio_id": "he_good_morning_1", "th_audio_id": "th_good_morning_1", "panel": "thai_worker", "is_urgent": false },
          { "id": "thai_good_evening_1", "display_text": "ערב טוב", "icon": "🌙", "he_text": "ערב טוב.", "th_text": "สวัสดีตอนเย็น", "he_audio_id": "he_good_evening_1", "th_audio_id": "th_good_evening_1", "panel": "thai_worker", "is_urgent": false },
          { "id": "thai_how_are_you_1", "display_text": "מה שלומך?", "icon": "�", "he_text": "מה שלומך?", "th_text": "สบายดีไหม?", "he_audio_id": "he_how_are_you_1", "th_audio_id": "th_how_are_you_1", "panel": "thai_worker", "is_urgent": false },
          { "id": "thai_how_do_you_feel_1", "display_text": "איך מרגיש?", "icon": "🤒", "he_text": "איך אתה מרגיש?", "th_text": "คุณรู้สึกอย่างไร?", "he_audio_id": "he_how_do_you_feel_1", "th_audio_id": "th_how_do_you_feel_1", "panel": "thai_worker", "is_urgent": false },

          { "id": "manager_load_cement_1", "display_text": "העמס מלט", "icon": "📦", "he_text": "תעמיס מלט.", "th_text": "ขนปูน", "he_audio_id": "he_load_cement_1", "th_audio_id": "th_load_cement_1", "panel": "manager", "is_urgent": false },
          { "id": "manager_organize_area_1", "display_text": "סדר אזור", "icon": "🧹", "he_text": "תבוא תסדר את האזור הזה.", "th_text": "มาจัดระเบียบพื้นที่นี้หน่อย", "he_audio_id": "he_organize_area_1", "th_audio_id": "th_organize_area_1", "panel": "manager", "is_urgent": false },
          { "id": "manager_clean_table_1", "display_text": "נקה שולחן", "icon": "🧼", "he_text": "תנקה את השולחן.", "th_text": "ทำความสะอาดโต๊ะ", "he_audio_id": "he_clean_table_1", "th_audio_id": "th_clean_table_1", "panel": "manager", "is_urgent": false },
          { "id": "manager_finish_now_1", "display_text": "סיים עכשיו", "icon": "⏱️", "he_text": "תסיים את העבודה עכשיו.", "th_text": "ทำงานให้เสร็จเดี๋ยวนี้", "he_audio_id": "he_finish_now_1", "th_audio_id": "th_finish_now_1", "panel": "manager", "is_urgent": true },
          { "id": "manager_come_here_1", "display_text": "בוא לכאן", "icon": "🚶‍♂️", "he_text": "בוא לכאן בבקשה.", "th_text": "มานี่หน่อยครับ/ค่ะ", "he_audio_id": "he_come_here_1", "th_audio_id": "th_come_here_1", "panel": "manager", "is_urgent": false },
          { "id": "manager_wait_1", "display_text": "חכה רגע", "icon": "⏰", "he_text": "חכה רגע בבקשה.", "th_text": "รอสักครู่ครับ/ค่ะ", "he_audio_id": "he_wait_1", "th_audio_id": "th_wait_1", "panel": "manager", "is_urgent": false },
          { "id": "manager_move_bags_1", "display_text": "העבר שקים", "icon": "➡️🛍️", "he_text": "להעביר את השקים.", "th_text": "ย้ายกระสอบ", "he_audio_id": "he_load_bags_1", "th_audio_id": "th_load_bags_1", "panel": "manager", "is_urgent": false },
          { "id": "manager_help_alaa_1", "display_text": "עזור לעלאא", "icon": "🤝", "he_text": "לעזור לעלאא.", "th_text": "ช่วยอลีอา", "he_audio_id": "he_help_alaa_1", "th_audio_id": "th_help_alaa_1", "panel": "manager", "is_urgent": false },
          { "id": "manager_help_adham_1", "display_text": "עזור לאדהם", "icon": "🤝", "he_text": "לעזור לאדהם.", "th_text": "ช่วยอดัม", "he_audio_id": "he_help_adham_1", "th_audio_id": "th_help_adham_1", "panel": "manager", "is_urgent": false },
          { "id": "manager_help_store_1", "display_text": "עזור לחנות", "icon": "🏪", "he_text": "לעזור לחנות.", "th_text": "ช่วยร้านค้า", "he_audio_id": "he_help_store_1", "th_audio_id": "th_help_store_1", "panel": "manager", "is_urgent": false },
          { "id": "manager_next_product_1", "display_text": "הבא מוצר", "icon": "📦➡️", "he_text": "ללכת להביא את המוצר הבא.", "th_text": "ไปเอาสินค้าชิ้นต่อไป", "he_audio_id": "he_next_product_1", "th_audio_id": "th_next_product_1", "panel": "manager", "is_urgent": false },
          { "id": "manager_good_morning_1", "display_text": "בוקר טוב", "icon": "☀️", "he_text": "בוקר טוב.", "th_text": "สวัสดีตอนเช้า", "he_audio_id": "he_good_morning_1", "th_audio_id": "th_good_morning_1", "panel": "manager", "is_urgent": false },
          { "id": "manager_good_evening_1", "display_text": "ערב טוב", "icon": "🌙", "he_text": "ערב טוב.", "th_text": "สวัสดีตอนเย็น", "he_audio_id": "he_good_evening_1", "th_audio_id": "th_good_evening_1", "panel": "manager", "is_urgent": false },
          { "id": "manager_how_are_you_1", "display_text": "מה שלומך?", "icon": "😊", "he_text": "מה שלומך?", "th_text": "สบายดีไหม?", "he_audio_id": "he_how_are_you_1", "th_audio_id": "th_how_are_you_1", "panel": "manager", "is_urgent": false },
          { "id": "manager_how_do_you_feel_1", "display_text": "איך מרגיש?", "icon": "🤒", "he_text": "איך אתה מרגיש?", "th_text": "คุณรู้สึกอย่างไร?", "he_audio_id": "he_how_do_you_feel_1", "th_audio_id": "th_how_do_you_feel_1", "panel": "manager", "is_urgent": false },
          { "id": "manager_come_help_loading_1", "display_text": "בוא לעזור", "icon": "💪", "he_text": "בוא תעזור לי בהעמסה.", "th_text": "มาช่วยผม/ฉัน ขนของหน่อย", "he_audio_id": "he_come_help_loading_1", "th_audio_id": "th_come_help_loading_1", "panel": "manager", "is_urgent": false }
        ];

        // רשימת משפטים לתרגום מיידי (קבועים ב-JS)
        const instantPhrases = {
            hebrew: [
                "כמה שקים להעמיס?",
                "אני צריך עזרה עכשיו בבקשה.",
                "איפה נמצא המחסן?",
                "הלקוח הזה מחכה לי.",
                "האם סיימת את המשימה?"
            ],
            thai: [
                "ต้องทำความสะอาดตอนนี้ไหม?", // Should I clean now?
                "ลูกค้าจะมาถึงเมื่อไหร่?", // When will the customer arrive?
                "มีงานอะไรอีกไหม?", // Is there any more work?
                "ผม/ฉัน ไม่เข้าใจ ช่วยอธิบายหน่อย.", // I don't understand, please explain.
                "ขออนุญาตไปซื้อของได้ไหม?" // May I go buy something?
            ],
            hebrew_numbers: [
                "מספר אחת", "מספר שתיים", "מספר שלוש", "מספר ארבע", "מספר חמש",
                "מספר שש", "מספר שבע", "מספר שמונה", "מספר תשע", "מספר עשר"
            ],
            thai_numbers: [
                "หมายเลขหนึ่ง", "หมายเลขสอง", "หมายเลขสาม", "หมายเลขสี่", "หมายเลขห้า",
                "หมายเลขหก", "หมายเลขเจ็ด", "หมายเลขแปด", "หมายเลขเก้า", "หมายเลขสิบ"
            ]
        };


        // פונקציה לטעינת נתוני המשפטים (המאגר עכשיו מובנה ב-JS)
        async function loadPhrases() {
            // אין צורך ב-fetch לקובץ חיצוני, הנתונים כבר כאן
            renderButtons(phrasesData);
            renderInstantPhraseButtons(); // קריאה לפונקציית רינדור המשפטים המיידיים
            renderNumberPhraseButtons(); // קריאה לפונקציית רינדור כפתורי המספרים
        }

        // פונקציה ליצירת כפתורים והצגתם בפאנלים המתאימים (משפטים קבועים)
        function renderButtons(phrases) {
            const thaiWorkerPanel = document.getElementById('thaiWorkerPanel');
            const managerPanel = document.getElementById('managerPanel');

            // ניקוי הפאנלים לפני הוספת כפתורים
            thaiWorkerPanel.innerHTML = '';
            managerPanel.innerHTML = '';


            phrases.forEach(phrase => {
                const button = document.createElement('button');
                // Tailwind classes for consistent button styling
                button.classList.add(
                    'flex', 'flex-col', 'items-center', 'justify-center', 'px-4', 'py-4', 'rounded-2xl', 'font-semibold',
                    'shadow-lg', 'hover:shadow-xl', 'transition-all', 'duration-200', 'active:scale-95',
                    'text-xl', 'text-white', 'text-center', 'min-h-[120px]', 'space-y-2' // רווח בין האייקון לטקסט
                );

                const iconSpan = document.createElement('span');
                iconSpan.textContent = phrase.icon || ''; // הוסף אייקון אם קיים
                iconSpan.classList.add('text-4xl'); // גודל גדול לאייקון

                const textSpan = document.createElement('span');
                textSpan.textContent = phrase.display_text || phrase.he_text; // טקסט הכפתור

                button.appendChild(iconSpan);
                button.appendChild(textSpan);

                if (phrase.panel === 'thai_worker') {
                    // כפתור לעובד תאילנדי: מציג טקסט עברי קצר, בלחיצה משמיע עברית למנהל, מציג פופאפ בעברית
                    // שימוש ב-base64AudioData במקום audioPath
                    button.onclick = () => {
                        const audioData = base64AudioData[phrase.he_audio_id];
                        if (!audioData || audioData.includes("TBD_")) {
                            console.warn(`הודעה: קובץ אודיו עבור ${phrase.he_audio_id} הוא דמה. אנא החלף אותו באודיו אמיתי.`);
                        }
                        showPopup(phrase.he_text, audioData, 'he', phrase.is_urgent);
                    };
                    button.classList.add('bg-green-600', 'hover:bg-green-700'); // צבע ירוק לעובד
                    thaiWorkerPanel.appendChild(button);
                } else if (phrase.panel === 'manager') {
                    // כפתור למנהל: מציג טקסט עברי קצר, בלחיצה משמיע תאית לעובד, מציג פופאפ בתאית
                    // שימוש ב-base64AudioData במקום audioPath
                    button.onclick = () => {
                        const audioData = base64AudioData[phrase.th_audio_id];
                        if (!audioData || audioData.includes("TBD_")) {
                            console.warn(`הודעה: קובץ אודיו עבור ${phrase.th_audio_id} הוא דמה. אנא החלף אותו באודיו אמיתי.`);
                        }
                        showPopup(phrase.th_text, audioData, 'th', phrase.is_urgent);
                    };
                    button.classList.add('bg-blue-600', 'hover:bg-blue-700'); // צבע כחול למנהל
                    managerPanel.appendChild(button);
                }
            });
        }

        // פונקציה ליצירת כפתורי משפטים לתרגום מיידי
        function renderInstantPhraseButtons() {
            const instantPhrasesHePanel = document.getElementById('instantPhrasesHe');
            const instantPhrasesThPanel = document.getElementById('instantPhrasesTh');

            instantPhrasesHePanel.innerHTML = '';
            instantPhrasesThPanel.innerHTML = '';

            // כפתורים לעברית (יתורגמו לתאית)
            instantPhrases.hebrew.forEach(phraseText => {
                const button = document.createElement('button');
                button.classList.add(
                    'flex', 'items-center', 'justify-center', 'px-4', 'py-3', 'rounded-lg', 'font-medium',
                    'shadow-md', 'hover:shadow-lg', 'transition-all', 'duration-200', 'active:scale-95',
                    'text-lg', 'text-white', 'text-center',
                    'bg-indigo-500', 'hover:bg-indigo-600' // צבעי כפתורים למשפטים מיידיים
                );
                button.textContent = phraseText;
                button.onclick = () => translateAndDisplayInstant(phraseText, 'he', 'th');
                instantPhrasesHePanel.appendChild(button);
            });

            // כפתורים לתאית (יתורגמו לעברית)
            instantPhrases.thai.forEach(phraseText => {
                const button = document.createElement('button');
                button.classList.add(
                    'flex', 'items-center', 'justify-center', 'px-4', 'py-3', 'rounded-lg', 'font-medium',
                    'shadow-md', 'hover:shadow-lg', 'transition-all', 'duration-200', 'active:scale-95',
                    'text-lg', 'text-white', 'text-center',
                    'bg-purple-500', 'hover:bg-purple-600', 'thai-text' // צבעים ופונט לתאית
                );
                button.textContent = phraseText;
                button.onclick = () => translateAndDisplayInstant(phraseText, 'th', 'he');
                instantPhrasesThPanel.appendChild(button);
            });
        }

        // פונקציה ליצירת כפתורי מספרים
        function renderNumberPhraseButtons() {
            const numberPhrasesHePanel = document.getElementById('numberPhrasesHe');
            const numberPhrasesThPanel = document.getElementById('numberPhrasesTh');

            numberPhrasesHePanel.innerHTML = '';
            numberPhrasesThPanel.innerHTML = '';

            // כפתורי מספרים בעברית (יתורגמו לתאית)
            instantPhrases.hebrew_numbers.forEach((phraseText, index) => {
                const button = document.createElement('button');
                button.classList.add(
                    'flex', 'items-center', 'justify-center', 'px-4', 'py-3', 'rounded-lg', 'font-medium',
                    'shadow-md', 'hover:shadow-lg', 'transition-all', 'duration-200', 'active:scale-95',
                    'text-xl', 'text-white', 'text-center',
                    'bg-pink-500', 'hover:bg-pink-600' // צבעי כפתורים למספרים
                );
                button.textContent = `${index + 1}. ${phraseText}`; // מציג "1. מספר אחת"
                button.onclick = () => translateAndDisplayInstant(phraseText, 'he', 'th');
                numberPhrasesHePanel.appendChild(button);
            });

            // כפתורי מספרים בתאית (יתורגמו לעברית)
            instantPhrases.thai_numbers.forEach((phraseText, index) => {
                const button = document.createElement('button');
                button.classList.add(
                    'flex', 'items-center', 'justify-center', 'px-4', 'py-3', 'rounded-lg', 'font-medium',
                    'shadow-md', 'hover:shadow-lg', 'transition-all', 'duration-200', 'active:scale-95',
                    'text-xl', 'text-white', 'text-center',
                    'bg-teal-500', 'hover:bg-teal-600', 'thai-text' // צבעים ופונט לתאית
                );
                button.textContent = `${index + 1}. ${phraseText}`; // מציג "1. หมายเลขหนึ่ง"
                button.onclick = () => translateAndDisplayInstant(phraseText, 'th', 'he');
                numberPhrasesThPanel.appendChild(button);
            });
        }


        // פונקציה להשמעת קובץ אודיו (מקבלת Base64 Data URL)
        function playAudio(audioDataUrl) {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
            // הוספת בדיקה אם ה-audioDataUrl תקין לפני יצירת אובייקט Audio
            if (!audioDataUrl || audioDataUrl.includes("TBD_")) {
                console.error("שגיאה בהשמעת אודיו: קובץ אודיו לא תקין או חסר.");
                // ניתן להציג הודעה למשתמש כאן במקום רק בקונסול
                return;
            }
            currentAudio = new Audio(audioDataUrl);
            currentAudio.play().catch(e => console.error("שגיאה בהשמעת אודיו:", e, "Source:", audioDataUrl));
        }

        // פונקציה להצגת הפופאפ (למשפטים קבועים וקלט חופשי)
        function showPopup(text, audioDataUrl, lang, isUrgent = false) {
            popupText.textContent = text;
            popupText.dir = (lang === 'he' ? 'rtl' : 'ltr'); // הגדר כיוון טקסט בפופאפ
            
            // הגדר פונט תאית אם השפה היא תאית
            if (lang === 'th') {
                popupText.classList.add('thai-text');
            } else {
                popupText.classList.remove('thai-text');
            }

            popupAudioUrl = audioDataUrl; // שמור את ה-URL של האודיו להשמעה חוזרת

            // אפס אנימציות קודמות
            popupContent.classList.remove('popup-animate', 'urgent-popup-animate', 'scale-100', 'opacity-100');
            popupContent.classList.add('scale-0', 'opacity-0');

            // הצג/הסתר אייקון התראה ופעל אנימציה דחופה
            if (isUrgent) {
                urgentIcon.classList.remove('hidden');
                popupContent.classList.add('urgent-popup-animate');
            } else {
                urgentIcon.classList.add('hidden');
            }

            popupOverlay.classList.remove('hidden'); // הצג את האוברליי
            // הפעל אנימציית פתיחה + הבהוב לאחר שהאוברליי נראה
            setTimeout(() => {
                popupContent.classList.remove('scale-0', 'opacity-0');
                popupContent.classList.add('scale-100', 'opacity-100');
                if (!isUrgent) { // אם זה לא דחוף, הפעל אנימציה רגילה
                    popupContent.classList.add('popup-animate');
                }
            }, 50); // השהייה קלה כדי לאפשר לרינדור לקרות

            playAudio(audioDataUrl); // השמע את הקול באופן מיידי

            // סגור את הפופאפ אוטומטית לאחר 5 שניות
            clearTimeout(popupCloseTimeout); // נקה טיים-אאוט קודם אם היה
            popupCloseTimeout = setTimeout(hidePopup, 5000);
        }

        // פונקציה לסגירת הפופאפ
        function hidePopup() {
            // הסר אנימציית הבהוב והפעל אנימציית סגירה
            popupContent.classList.remove('popup-animate', 'urgent-popup-animate', 'scale-100', 'opacity-100');
            popupContent.classList.add('scale-0', 'opacity-0');
            setTimeout(() => {
                popupOverlay.classList.add('hidden'); // הסתר את האוברליי לחלוטין לאחר האנימציה
                urgentIcon.classList.add('hidden'); // וודא שאייקון ההתראה מוסתר
            }, 300); // תואם את משך המעבר (transition) ב-CSS
            clearTimeout(popupCloseTimeout); // נקה את הטיים-אאוט של סגירה אוטומטית
        }

        // לחיצה על כפתור השמעה חוזרת בפופאפ
        popupReplayButton.addEventListener('click', () => {
            playAudio(popupAudioUrl);
        });

        // לחיצה על כפתור סגירה בפופאפ
        popupCloseButton.addEventListener('click', hidePopup);

        // לחיצה על האוברליי סוגרת את הפופאפ
        popupOverlay.addEventListener('click', (e) => {
            if (e.target === popupOverlay) { // וודא שהלחיצה הייתה על האוברליי עצמו ולא על התוכן
                hidePopup();
            }
        });


        // ----- לוגיקה עבור תרגום משפטים מיידיים -----

        let typingInterval;

        // פונקציה לתרגום והצגה עם אנימציה עבור משפטים מיידיים
        async function translateAndDisplayInstant(text, sourceLang, targetLang) {
            instantTranslationOutput.textContent = 'מתרגם...'; // הודעת טעינה
            instantTranslationOutput.classList.remove('rainbow-border'); // הסר אנימציה קודמת
            instantTranslationOutput.classList.remove('typing-effect'); // הסר אפקט קלדה קודם
            instantTranslationOutput.classList.remove('thai-text'); // הסר פונט תאית אם לא רלוונטי

            // קביעת כיוון טקסט לאזור התרגום המיידי
            instantTranslationOutput.dir = (targetLang === 'he' ? 'rtl' : 'ltr');
            if (targetLang === 'th') {
                instantTranslationOutput.classList.add('thai-text');
            } else {
                instantTranslationOutput.classList.remove('thai-text');
            }

            try {
                // שלב 1: בקשה לשרת הפלאסק לקבלת קובץ האודיו של התרגום
                const audioResponse = await fetch(`${SERVER_URL}/translate_and_speak`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        source_lang: sourceLang,
                        target_lang: targetLang
                    })
                });

                if (!audioResponse.ok) {
                    const errorData = await audioResponse.json();
                    throw new Error(`שגיאת שרת אודיו: ${audioResponse.status} - ${errorData.error || 'שגיאה לא ידועה'}. ודא ששרת הפלאסק פועל בכתובת ${SERVER_URL}.`);
                }

                const audioBlob = await audioResponse.blob();
                const audioUrl = URL.createObjectURL(audioBlob);


                // שלב 2: בקשה נפרדת לשרת הפלאסק לקבלת הטקסט המתורגם בלבד
                const textResponse = await fetch(`${SERVER_URL}/translate_only`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        source_lang: sourceLang,
                        target_lang: targetLang
                    })
                });

                if (!textResponse.ok) {
                    const errorData = await textResponse.json();
                    throw new Error(`שגיאת שרת טקסט: ${textResponse.status} - ${errorData.error || 'שגיאה לא ידועה'}. ודא ששרת הפלאסק פועל בכתובת ${SERVER_URL}.`);
                }

                const translatedTextResult = await textResponse.json();
                const translatedText = translatedTextResult.translatedText;

                // הפעל אפקט הקלדה
                instantTranslationOutput.textContent = ''; // נקה לפני ההקלדה
                instantTranslationOutput.classList.add('typing-effect'); // הוסף את הקלאס לאפקט

                let i = 0;
                clearInterval(typingInterval); // נקה כל אינטרוול קודם
                typingInterval = setInterval(() => {
                    if (i < translatedText.length) {
                        instantTranslationOutput.textContent += translatedText.charAt(i);
                        i++;
                    } else {
                        clearInterval(typingInterval);
                        instantTranslationOutput.classList.remove('typing-effect'); // הסר את הקלאס בסיום ההקלדה
                        instantTranslationOutput.classList.add('rainbow-border'); // הוסף אנימציית קשת בענן
                    }
                }, 50); // מהירות הקלדה (מילישניות לתו)

                playAudio(audioUrl); // השמע את האודיו

            } catch (error) {
                console.error("שגיאה בתרגום מיידי:", error);
                instantTranslationOutput.textContent = `שגיאה בתרגום מיידי: ${error.message}. אנא ודא ששרת הפלאסק שלך פועל כראוי (http://localhost:5000) ושהוא מאפשר בקשות CORS.`;
                instantTranslationOutput.classList.remove('rainbow-border');
                instantTranslationOutput.classList.remove('typing-effect');
                instantTranslationOutput.dir = 'rtl'; // ברירת מחדל בעברית לשגיאות
            }
        }


        // ----- לוגיקה עבור המקלדת והתרגום החופשי -----

        // אתחול המקלדת הווירטואלית
        function initKeyboard() {
            const freeTextInput = document.getElementById('freeTextInput');
            keyboard = new SimpleKeyboard.default({
                input: freeTextInput, // קושר את המקלדת לשדה הטקסט
                layout: layoutOptions[currentKeyboardLayout], // פריסת המקלדת הראשונית
                rtl: currentKeyboardLayout === 'hebrew', // הגדרת כיווניות (RTL לעברית)
                onChange: input => freeTextInput.value = input, // עדכון שדה הטקסט עם הקלדת המשתמש
                onKeyPress: button => onKeyPress(button), // פונקציה לטיפול בלחיצות מקשים
                theme: "hg-theme-default", // נושא עיצוב בסיסי של simple-keyboard
                display: {
                    '{bksp}': 'מחק',
                    '{tab}': 'טאב',
                    '{capslock}': 'Caps Lock',
                    '{shift}': 'Shift',
                    '{space}': 'רווח'
                }
            });

            // עדכון המקלדת כאשר משתמש מקליד ישירות לשדה הטקסט
            freeTextInput.addEventListener('input', event => {
                keyboard.setInput(event.target.value);
            });

            // הגדר כיוון טקסט התחלתי
            document.getElementById('freeTextInput').dir = currentKeyboardLayout === 'hebrew' ? 'rtl' : 'ltr';
        }

        // טיפול בלחיצות מקשים מיוחדים במקלדת
        function onKeyPress(button) {
            // עבור Shift או Caps Lock, החלף בין פריסות המקלדת (רגיל/Shift)
            if (button === "{shift}" || button === "{capslock}") {
                toggleShift();
            }
        }

        // החלפה בין מצב Shift למצב רגיל במקלדת
        function toggleShift() {
            let currentLayoutName = keyboard.options.layoutName;
            let newLayoutName = currentLayoutName === "default" ? "shift" : "default";
            keyboard.setOptions({ layoutName: newLayoutName });
        }

        // לחיצה על כפתור "הקלד בעברית" - מעביר את המקלדת למצב עברית
        document.getElementById('setLangHe').addEventListener('click', () => {
            currentKeyboardLayout = 'hebrew';
            keyboard.setOptions({
                layout: layoutOptions['hebrew'],
                rtl: true
            });
            document.getElementById('freeTextInput').dir = 'rtl';
            keyboard.setInput(''); // נקה את שדה הטקסט בלחיצת מעבר שפה
            instantTranslationOutput.classList.remove('rainbow-border'); // נקה אנימציה מאזור התרגום המיידי
            instantTranslationOutput.classList.remove('typing-effect');
        });

        // לחיצה על כפתור "พิมพ์ภาษาไทย" (הקלד בתאית) - מעביר את המקלדת למצב תאית
        document.getElementById('setLangTh').addEventListener('click', () => {
            currentKeyboardLayout = 'thai';
            keyboard.setOptions({
                layout: layoutOptions['thai'],
                rtl: false
            });
            document.getElementById('freeTextInput').dir = 'ltr';
            keyboard.setInput(''); // נקה את שדה הטקסט בלחיצת מעבר שפה
            instantTranslationOutput.classList.remove('rainbow-border'); // נקה אנימציה מאזור התרגום המיידי
            instantTranslationOutput.classList.remove('typing-effect');
        });

        // פונקציית תרגום והשמעה עבור טקסט חופשי (מתקשרת לשרת הפלאסק)
        document.getElementById('speakTranslated').addEventListener('click', async () => {
            const text = document.getElementById('freeTextInput').value.trim();
            if (!text) {
                alert("אנא הקלד טקסט לתרגום והשמעה.");
                return;
            }

            let sourceLang; // שפת המקור של הטקסט שנקלט
            let targetLang; // שפת היעד של התרגום וההשמעה

            // קביעת שפות המקור והיעד בהתבסס על פריסת המקלדת הנוכחית
            if (currentKeyboardLayout === 'hebrew') {
                sourceLang = 'he';
                targetLang = 'th'; // אם המשתמש כותב בעברית, נתרגם ונשמיע בתאית (לצורך העובד)
            } else {
                sourceLang = 'th';
                targetLang = 'he'; // אם המשתמש כותב בתאית, נתרגם ונשמיע בעברית (לצורך המנהל)
            }

            try {
                // שלב 1: בקשה לשרת הפלאסק לקבלת קובץ האודיו של התרגום
                const audioResponse = await fetch(`${SERVER_URL}/translate_and_speak`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        source_lang: sourceLang,
                        target_lang: targetLang
                    })
                });

                if (!audioResponse.ok) {
                    const errorData = await audioResponse.json();
                    throw new Error(`שגיאת שרת אודיו: ${audioResponse.status} - ${errorData.error || 'שגיאה לא ידועה'}. ודא ששרת הפלאסק פועל בכתובת ${SERVER_URL}.`);
                }

                const audioBlob = await audioResponse.blob();
                const audioUrl = URL.createObjectURL(audioBlob);

                // שלב 2: בקשה נפרדת לשרת הפלאסק לקבלת הטקסט המתורגם בלבד (לצורך הצגה בפופאפ)
                const textResponse = await fetch(`${SERVER_URL}/translate_only`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        source_lang: sourceLang,
                        target_lang: targetLang
                    })
                });

                if (!textResponse.ok) {
                    const errorData = await textResponse.json();
                    throw new Error(`שגיאת שרת טקסט: ${textResponse.status} - ${errorData.error || 'שגיאה לא ידועה'}. ודא ששרת הפלאסק פועל בכתובת ${SERVER_URL}.`);
                }

                const translatedTextResult = await textResponse.json();
                const translatedText = translatedTextResult.translatedText;
                const popupLang = targetLang; // שפת הטקסט בפופאפ היא שפת היעד של התרגום

                showPopup(translatedText, audioUrl, popupLang); // הצג את התרגום בפופאפ והשמע את האודיו

            } catch (error) {
                console.error("שגיאה בתרגום או השמעה:", error);
                alert("שגיאה בתרגום או השמעה: " + error.message + "\nאנא ודא ששרת הפלאסק שלך פועל כראוי (http://localhost:5000) ושהוא מאפשר בקשות CORS.");
            }
        });

        // טען את המשפטים עם טעינת הדף ואתחל את המקלדת
        document.addEventListener('DOMContentLoaded', () => {
            loadPhrases();
            initKeyboard();
        });
    </script>

</body>
</html>
�
