import React, { useState, useEffect, useCallback, useRef } from 'react';
import dayjs from 'dayjs';
import customParseFormat from 'dayjs/plugin/customParseFormat';
import isoWeek from 'dayjs/plugin/isoWeek';
import relativeTime from 'dayjs/plugin/relativeTime';

dayjs.extend(customParseFormat);
dayjs.extend(isoWeek);
dayjs.extend(relativeTime);

// IMPORTANT: Tailwind CSS configuration and global styles must be included in your main HTML file.
// Please add the Tailwind CSS script, configuration (inside a <script> tag),
// and global styles (inside a <style> tag) to your HTML <head> section.
// Refer to previous versions or Tailwind CSS documentation for the exact configurations.


// --- Constants and Utility Functions ---
const SHEET_ID = 'YOUR_GOOGLE_SHEET_ID_HERE'; // Replace with your actual Google Sheet ID
const API_URL = "https://script.google.com/macros/s/AKfycbzeBkksUNhwEuyVaQHaIDsnSGWAVtKp5RU6r95dDrqd21gRY_s1esytzxEBWDvxhjMfYQ/exec"; // Example Apps Script URL
const API_TOKEN = "12345ABC"; // Example API Token

const DRIVERS_INFO = {
  'עלי': {
    id: 'ALI',
    name: 'עלי',
    slogan: 'מומחה בהובלות קטנות',
    image: 'https://i.postimg.cc/tCNbgXK3/Screenshot-20250623-200744-Tik-Tok.jpg',
    jobType: 'MANUAL', // Default job type for Ali
    color: 'manual', // Tailwind class prefix for colors (Green)
    speed: 55, // km/h
    vehicle: 'איסוזו 5T'
  },
  'חכמת': {
    id: 'HIKMAT',
    name: 'חכמת',
    slogan: 'הובלות מנוף מורכבות',
    image: 'https://i.postimg.cc/d3S0NJJZ/Screenshot-20250623-200646-Facebook.jpg',
    jobType: 'CRANE', // Default job type for Hikmat
    color: 'crane', // Tailwind class prefix for colors (Blue)
    speed: 50, // km/h
    vehicle: 'מרצדס 12T'
  }
};

const JOB_TYPES = {
    MANUAL: { label: 'פריקה ידנית', svcDefaultMin: 45 },
    CRANE: { label: 'עבודת מנוף / הובלת מנוף', svcDefaultMin: 90 },
};

// Consolidated unique status values (Hebrew strings)
const STATUSES = [
  'מתכונן ליציאה',
  'בדרך',
  'העמסה',
  'נדחה למועד אחר',
  'סופק',
  'סופק חלקית',
  'מוכנה',
  'בטיפול',
  'בוטל',
];

const WAREHOUSES = {
    HARASH: { code: 4, label: 'מחסן החרש (4) – החרש 10, הוד השרון' },
    TALMID: { code: 1, label: 'מחסן התלמיד (1) – התלמיד 6, הוד השרון' },
};

const DEFAULT_CITIES = { // Default city distances from Hod Hasharon (km)
  'הוד השרון': 0, 'רעננה': 5, 'כפר סבא': 6, 'הרצליה': 9, 'תל אביב-יפו': 18, 'פתח תקווה': 10, 'נתניה': 25, 'מודיעין-מכבים-רעות': 35, 'חיפה': 85,
};

// Global state for cities, could be fetched from API or stored in localStorage
let appState = {
  cities: DEFAULT_CITIES
};

const U = {
  uid: () => Math.random().toString(36).slice(2),
  fmtTime: (m) => dayjs().startOf('day').add(m, 'minute').format('HH:mm'),
  parseTimeToMinutes: (hhmm) => {
    const [h, m] = hhmm.split(':').map(Number); return h*60 + m;
  },
  clamp: (v, min, max) => Math.min(Math.max(v, min), max),
  km: (n) => `${Number(n).toFixed(0)} ק"מ`,
  min: (n) => `${Number(n).toFixed(0)} ד׳`,
  todayStr: () => dayjs().format('YYYY-MM-DD'),
  tomorrowStr: () => dayjs().add(1,'day').format('YYYY-MM-DD'),
  encode: (str) => encodeURIComponent(str || ''),
};

// --- API Communication (Adapted from index (21).html) ---
async function callApi(action, payload) {
  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CRM-TOKEN': API_TOKEN },
      body: JSON.stringify({ action, payload })
    });
    const data = await response.json();
    if (!data.ok) {
      throw new Error(data.error || 'API error');
    }
    return data.data;
  } catch (error) {
    console.error('API call failed:', error);
    // In a real app, you'd show a user-friendly error message
    return null;
  }
}

// Function to fetch data from Google Sheets directly (adapted from index (22).html)
async function fetchOrdersFromSheet() {
  if (!SHEET_ID || SHEET_ID === 'YOUR_GOOGLE_SHEET_ID_HERE') {
    console.warn("Please update SHEET_ID with your actual Google Sheet ID.");
    // Return sample data if SHEET_ID is not set for demo purposes
    return [
      { id: U.uid(), driverName: 'עלי', date: U.todayStr(), time: '08:00', warehouse: 'HARASH', status: 'מתכונן ליציאה', customerName: 'אגם נכסים', address: 'החרש 10', city: 'הוד השרון', orderType: 'פריקה ידנית', jobType: 'MANUAL', km: 0, travelMin: 0, serviceMin: JOB_TYPES.MANUAL.svcDefaultMin, arriveHHMM: '08:00', finishHHMM: '08:45' },
      { id: U.uid(), driverName: 'חכמת', date: U.todayStr(), time: '10:00', warehouse: 'TALMID', status: 'בדרך', customerName: 'שני אילתי', address: 'מודיעין', city: 'מודיעין-מכבים-רעות', orderType: 'הובלת מנוף', jobType: 'CRANE', km: 35, travelMin: (35/DRIVERS_INFO['חכמת'].speed)*60, serviceMin: JOB_TYPES.CRANE.svcDefaultMin, arriveHHMM: '10:42', finishHHMM: '12:12' },
      { id: U.uid(), driverName: 'עלי', date: U.todayStr(), time: '12:00', warehouse: 'HARASH', status: 'סופק', customerName: 'תמר וולדורף', address: 'ויצמן 1', city: 'הוד השרון', orderType: 'פריקה ידנית', jobType: 'MANUAL', km: 0, travelMin: 0, serviceMin: JOB_TYPES.MANUAL.svcDefaultMin, arriveHHMM: '12:00', finishHHMM: '12:45' },
      { id: U.uid(), driverName: 'חכמת', date: U.tomorrowStr(), time: '07:00', warehouse: 'HARASH', status: 'מתכונן ליציאה', customerName: 'מידן לירן', address: 'הוד השרון', city: 'הוד השרון', orderType: 'עבודת מנוף', jobType: 'CRANE', km: 0, travelMin: 0, serviceMin: JOB_TYPES.CRANE.svcDefaultMin, arriveHHMM: '07:00', finishHHMM: '08:30' },
    ];
  }

  const sheetUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
  try {
    const response = await fetch(sheetUrl);
    const text = await response.text();
    const json = JSON.parse(text.substring(47, text.length - 2));
    const rows = json.table.rows.map(row => row.c.map(cell => cell ? cell.v : ''));

    // Assuming the header row is the first row
    const headers = rows[0];
    const data = rows.slice(1).map(row => {
      const order = {};
      headers.forEach((header, index) => {
        let key = '';
        switch(header) { // Map Hebrew headers to English keys
          case 'שם נהג': key = 'driverName'; break;
          case 'תאריך': key = 'date'; break;
          case 'שעה': key = 'time'; break;
          case 'מחסן': key = 'warehouse'; break;
          case 'סטטוס': key = 'status'; break;
          case 'שם לקוח': key = 'customerName'; break;
          case 'כתובת אספקה': key = 'address'; break;
          case 'עיר': key = 'city'; break;
          case 'סוג פעולה': key = 'orderType'; break;
          case 'סוג עבודה': key = 'jobType'; break;
          default: key = header.toLowerCase().replace(/\s/g, ''); // Generic conversion for any other columns
        }
        order[key] = row[index];
      });

      if (!order.jobType) {
        order.jobType = order.orderType && order.orderType.includes('מנוף') ? 'CRANE' : 'MANUAL';
      }

      const driver = DRIVERS_INFO[order.driverName]?.id;
      if (driver && order.city && order.time && order.jobType) {
        const etaData = calcETA({
          driver,
          jobType: order.jobType,
          city: order.city,
          startHHMM: order.time
        });
        Object.assign(order, etaData);
      } else {
        order.km = order.km || 0;
        order.travelMin = order.travelMin || 0;
        order.serviceMin = order.serviceMin || (order.jobType === 'CRANE' ? JOB_TYPES.CRANE.svcDefaultMin : JOB_TYPES.MANUAL.svcDefaultMin);
        order.arriveHHMM = order.arriveHHMM || order.time;
        order.finishHHMM = order.finishHHMM || U.fmtTime(U.parseTimeToMinutes(order.time) + order.serviceMin);
      }

      order.id = U.uid();
      return order;
    });
    return data;
  } catch (error) {
    console.error('Failed to fetch data from Google Sheets:', error);
    return [];
  }
}

// Function to calculate ETA (from index (21).html)
function calcETA({driver, jobType, city, startHHMM}){
  const km = appState.cities[city] ?? 0;
  const spd = DRIVERS_INFO[driver === 'ALI' ? 'עלי' : 'חכמת'].speed;
  const travelMin = (km / spd) * 60;
  const serviceMin = JOB_TYPES[jobType].svcDefaultMin;
  const startMin = U.parseTimeToMinutes(startHHMM || '09:00');
  const arriveHHMM = U.fmtTime(startMin + travelMin);
  const finishHHMM = U.fmtTime(startMin + travelMin + serviceMin);
  return { km, travelMin: Math.round(travelMin), serviceMin, arriveHHMM, finishHHMM };
}


// --- Common UI Components ---

const LoadingSpinner = () => (
  <div className="flex items-center justify-center space-x-2 text-white mb-6">
    <svg className="animate-spin h-5 w-5 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <span>טוען נתונים...</span>
  </div>
);

const getStatusColorClass = (status) => {
  switch (status) {
    case 'מתכונן ליציאה': return 'bg-blue-600 text-white';
    case 'בדרך': return 'bg-yellow-600 text-white';
    case 'סופק': return 'bg-green-600 text-white';
    case 'נדחה למועד אחר': return 'bg-red-600 text-white';
    case 'מוכנה': return 'bg-purple-600 text-white';
    case 'בטיפול': return 'bg-gray-600 text-white';
    case 'בוטל': return 'bg-red-600 text-white';
    case 'העמסה': return 'bg-indigo-600 text-white'; // Changed to indigo for 'loading'
    case 'סופק חלקית': return 'bg-orange-600 text-white';
    default: return 'bg-gray-600 text-white';
  }
};

const TableRow = ({ order, isDriverPage = false, onEdit, onDelete }) => (
  <tr className="bg-dark-card-bg even:bg-dark-card-bg/70 hover:bg-white/10 transition-colors border-b border-dark-border last:border-b-0">
    {!isDriverPage && <td className="p-3 whitespace-nowrap text-base font-medium text-white">{order.driverName}</td>}
    <td className="p-3 whitespace-nowrap text-base text-white/90">{order.date}</td>
    <td className="p-3 whitespace-nowrap text-base text-white/90">{order.time}</td>
    <td className="p-3 whitespace-nowrap text-base text-white/90">{WAREHOUSES[order.warehouse]?.label || order.warehouse}</td>
    <td className="p-3 whitespace-nowrap text-base">
      <span className={`px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColorClass(order.status)}`}>
        {order.status}
      </span>
    </td>
    <td className="p-3 whitespace-nowrap text-base text-white/90">{order.customerName}</td>
    <td className="p-3 whitespace-nowrap text-base text-white/90">{order.address}</td>
    <td className="p-3 whitespace-nowrap text-base text-white/90">{order.orderType}</td>
    {!isDriverPage && (
      <td className="p-3 whitespace-nowrap text-left text-base font-medium">
        <button onClick={() => onEdit(order.id)} className="text-indigo-400 hover:text-indigo-200 ml-3 transition-colors text-sm">ערוך</button>
        <button onClick={() => onDelete(order.id)} className="text-red-400 hover:text-red-200 transition-colors text-sm">מחק</button>
      </td>
    )}
  </tr>
);

// --- Modals ---
const OrderModal = ({ isOpen, onClose, onSubmit, initialData = {} }) => {
  const [formData, setFormData] = useState(initialData);

  useEffect(() => {
    setFormData(initialData);
  }, [initialData, isOpen]);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    onSubmit(formData);
    onClose();
  };

  return (
    <div className={`fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-center z-50 ${isOpen ? 'flex' : 'hidden'}`}>
      <div className="glass w-full max-w-lg mx-4 rounded-3xl p-6 border border-dark-border shadow-glow">
        <h3 className="text-2xl font-bold mb-4 text-white">הוסף/ערוך הזמנה</h3>
        <form onSubmit={handleSubmit}>
          <div className="mb-4">
            <label htmlFor="driverName" className="block text-white/70 mb-1">שם נהג:</label>
            <select id="driverName" name="driverName" value={formData.driverName || ''} onChange={handleChange} required className="w-full px-3 py-2 rounded-2xl bg-dark-card-bg border border-dark-border text-white focus:outline-none focus:ring-2 focus:ring-primary">
              {Object.keys(DRIVERS_INFO).map(driverKey => (
                <option key={driverKey} value={driverKey}>{DRIVERS_INFO[driverKey].name}</option>
              ))}
            </select>
          </div>
          <div className="mb-4">
            <label htmlFor="customerName" className="block text-white/70 mb-1">שם לקוח:</label>
            <input type="text" id="customerName" name="customerName" value={formData.customerName || ''} onChange={handleChange} required className="w-full px-3 py-2 rounded-2xl bg-dark-card-bg border border-dark-border text-white rtl-input focus:outline-none focus:ring-2 focus:ring-primary" placeholder="שם לקוח" />
          </div>
          <div className="mb-4">
            <label htmlFor="city" className="block text-white/70 mb-1">עיר:</label>
            <input type="text" id="city" name="city" value={formData.city || ''} onChange={handleChange} required className="w-full px-3 py-2 rounded-2xl bg-dark-card-bg border border-dark-border text-white rtl-input focus:outline-none focus:ring-2 focus:ring-primary" placeholder="עיר" />
          </div>
          <div className="mb-4">
            <label htmlFor="address" className="block text-white/70 mb-1">כתובת אספקה:</label>
            <input type="text" id="address" name="address" value={formData.address || ''} onChange={handleChange} required className="w-full px-3 py-2 rounded-2xl bg-dark-card-bg border border-dark-border text-white rtl-input focus:outline-none focus:ring-2 focus:ring-primary" placeholder="רחוב ומספר" />
          </div>
          <div className="mb-4">
            <label htmlFor="orderType" className="block text-white/70 mb-1">סוג פעולה:</label>
            <select id="orderType" name="orderType" value={formData.orderType || ''} onChange={handleChange} required className="w-full px-3 py-2 rounded-2xl bg-dark-card-bg border border-dark-border text-white focus:outline-none focus:ring-2 focus:ring-primary">
              <option value="הובלה אזורי">הובלה אזורי</option>
              <option value="פריקה ידנית">פריקה ידנית</option>
              <option value="גישה לאתר">גישה לאתר</option>
              <option value="הובלת מנוף">הובלת מנוף</option>
              <option value="הובלת מנוף 15 מטר">הובלת מנוף 15 מטר</option>
              <option value="איסוף בלות פסולת">איסוף בלות פסולת</option>
              <option value="עבודת מנוף">עבודת מנוף</option>
            </select>
          </div>
          <div className="mb-4">
            <label htmlFor="status" className="block text-white/70 mb-1">סטטוס:</label>
            <select id="status" name="status" value={formData.status || ''} onChange={handleChange} required className="w-full px-3 py-2 rounded-2xl bg-dark-card-bg border border-dark-border text-white focus:outline-none focus:ring-2 focus:ring-primary">
              {STATUSES.map(statusValue => (
                <option key={statusValue} value={statusValue}>{statusValue}</option>
              ))}
            </select>
          </div>
          <div className="mb-4">
            <label htmlFor="date" className="block text-white/70 mb-1">תאריך אספקה:</label>
            <input type="date" id="date" name="date" value={formData.date || ''} onChange={handleChange} required className="w-full px-3 py-2 rounded-2xl bg-dark-card-bg border border-dark-border text-white focus:outline-none focus:ring-2 focus:ring-primary" />
          </div>
          <div className="mb-4">
            <label htmlFor="time" className="block text-white/70 mb-1">שעת אספקה:</label>
            <input type="time" id="time" name="time" value={formData.time || ''} onChange={handleChange} required className="w-full px-3 py-2 rounded-2xl bg-dark-card-bg border border-dark-border text-white focus:outline-none focus:ring-2 focus:ring-primary" />
          </div>
          <div className="flex justify-end space-x-2">
            <button type="button" onClick={onClose} className="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition-colors">ביטול</button>
            <button type="submit" className="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">שמור</button>
          </div>
        </form>
      </div>
    </div>
  );
};

const CustomAlert = ({ message, onClose, type = 'info' }) => {
  let bgColor, textColor, borderColor;
  switch (type) {
    case 'success': bgColor = 'bg-green-600'; textColor = 'text-white'; borderColor = 'border-green-400'; break;
    case 'error': bgColor = 'bg-red-600'; textColor = 'text-white'; borderColor = 'border-red-400'; break;
    case 'warning': bgColor = 'bg-yellow-600'; textColor = 'text-white'; borderColor = 'border-yellow-400'; break;
    default: bgColor = 'bg-blue-600'; textColor = 'text-white'; borderColor = 'border-blue-400'; break;
  }

  return (
    <div className={`fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-center z-50`}>
      <div className={`${bgColor} ${textColor} p-6 rounded-lg shadow-lg flex flex-col items-center max-w-sm text-center border ${borderColor}`}>
        <p className="text-lg mb-4">{message}</p>
        <button onClick={onClose} className="px-4 py-2 bg-white/10 rounded-lg shadow hover:bg-white/20 text-white">
          אישור
        </button>
      </div>
    </div>
  );
};

// --- Timeline Component ---
const DAY_START_MIN = 6 * 60; // 06:00
const DAY_END_MIN = 16 * 60; // 16:00
const DAY_TOTAL_MIN = DAY_END_MIN - DAY_START_MIN;

const Timeline = ({ orders, onUpdateOrder }) => {
  const laneRefs = {
    ALI: useRef(null),
    HIKMAT: useRef(null),
  };

  const getOrderPosition = useCallback((order) => {
    const startMin = U.parseTimeToMinutes(order.time);
    const orderDuration = order.travelMin + order.serviceMin;
    const clampedStartMin = U.clamp(startMin, DAY_START_MIN, DAY_END_MIN - Math.max(orderDuration, 15)); // Ensure order doesn't start after end of day
    const leftPct = ((clampedStartMin - DAY_START_MIN) / DAY_TOTAL_MIN) * 100;
    const widthPct = (Math.max(orderDuration, 15) / DAY_TOTAL_MIN) * 100; // Minimum 15 min display

    return { left: `${leftPct}%`, width: `${widthPct}%` };
  }, []);

  const handleDrag = useCallback((e, orderId, driverId) => {
    let startX = (e.touches ? e.touches[0].clientX : e.clientX);
    const orderElement = e.currentTarget;
    const laneElement = laneRefs[driverId].current;
    if (!laneElement) return;

    const initialLeft = orderElement.offsetLeft;
    const orderWidth = orderElement.offsetWidth; // Get current rendered width
    const laneWidth = laneElement.clientWidth;

    orderElement.classList.add('dragging');

    const onMouseMove = (moveEvent) => {
      moveEvent.preventDefault(); // Prevent scrolling on touch devices
      const currentX = (moveEvent.touches ? moveEvent.touches[0].clientX : moveEvent.clientX);
      const deltaX = currentX - startX;
      let newLeft = initialLeft + deltaX;

      // Clamp newLeft within lane bounds
      newLeft = U.clamp(newLeft, 0, laneWidth - orderWidth);
      orderElement.style.left = `${newLeft}px`;
    };

    const onMouseUp = () => {
      orderElement.classList.remove('dragging');
      window.removeEventListener('mousemove', onMouseMove);
      window.removeEventListener('touchmove', onMouseMove);
      window.removeEventListener('mouseup', onMouseUp);
      window.removeEventListener('touchend', onMouseUp);

      // Calculate new time based on final position
      const finalLeft = orderElement.offsetLeft;
      const leftPct = finalLeft / laneWidth;
      const snappedMin = Math.round(((leftPct * DAY_TOTAL_MIN) + DAY_START_MIN) / 15) * 15; // Snap to 15-minute intervals
      const newTime = U.fmtTime(snappedMin);

      onUpdateOrder(orderId, { time: newTime });
    };

    window.addEventListener('mousemove', onMouseMove, { passive: false });
    window.addEventListener('touchmove', onMouseMove, { passive: false });
    window.addEventListener('mouseup', onMouseUp);
    window.addEventListener('touchend', onMouseUp);
  }, [onUpdateOrder]);

  const handleResize = useCallback((e, orderId, driverId) => {
    e.stopPropagation(); // Prevent drag from starting
    let startX = (e.touches ? e.touches[0].clientX : e.clientX);
    const orderElement = e.currentTarget.parentElement; // The order-block div
    const laneElement = laneRefs[driverId].current;
    if (!laneElement) return;

    const initialWidth = orderElement.offsetWidth;
    const initialLeft = orderElement.offsetLeft;
    const laneWidth = laneElement.clientWidth;

    orderElement.classList.add('resizing');

    const onMouseMove = (moveEvent) => {
      moveEvent.preventDefault();
      const currentX = (moveEvent.touches ? moveEvent.touches[0].clientX : moveEvent.clientX);
      const deltaX = currentX - startX;
      let newWidth = initialWidth + deltaX;

      // Ensure min width and within lane bounds
      newWidth = U.clamp(newWidth, 20, laneWidth - initialLeft); // Minimum 20px width

      orderElement.style.width = `${newWidth}px`;
    };

    const onMouseUp = () => {
      orderElement.classList.remove('resizing');
      window.removeEventListener('mousemove', onMouseMove);
      window.removeEventListener('touchmove', onMouseMove);
      window.removeEventListener('mouseup', onMouseUp);
      window.removeEventListener('touchend', onMouseUp);

      // Calculate new duration based on final width
      const finalWidth = orderElement.offsetWidth;
      const widthPct = finalWidth / laneWidth;
      const newDuration = Math.round((widthPct * DAY_TOTAL_MIN) / 15) * 15; // Snap to 15-minute intervals
      
      const order = orders.find(o => o.id === orderId);
      if (order) {
        // Recalculate serviceMin or add a new 'duration' field to order object
        // For simplicity, let's just update serviceMin for now, keeping travelMin constant
        const newServiceMin = newDuration - order.travelMin;
        onUpdateOrder(orderId, { serviceMin: Math.max(0, newServiceMin), finishHHMM: U.fmtTime(U.parseTimeToMinutes(order.arriveHHMM) + Math.max(0, newServiceMin)) });
      }
    };

    window.addEventListener('mousemove', onMouseMove, { passive: false });
    window.addEventListener('touchmove', onMouseMove, { passive: false });
    window.addEventListener('mouseup', onMouseUp);
    window.addEventListener('touchend', onMouseUp);
  }, [orders, onUpdateOrder]);


  const todayOrders = orders.filter(o => o.date === U.todayStr());

  return (
    <section className="mt-8 grid grid-cols-1 gap-6">
      <h2 className="text-2xl md:text-3xl font-bold text-white mb-4">ציר זמן – היום</h2>

      <div className="glass rounded-3xl p-4 shadow-glow"> {/* Added shadow-glow here */}
        <div className="flex flex-col md:flex-row items-start md:items-center gap-3 mb-3 text-base text-white/80">
          <div className="flex items-center gap-2">
            <div className={`w-3 h-3 rounded-full bg-${DRIVERS_INFO['עלי'].color}`}></div>
            <span>{DRIVERS_INFO['עלי'].name} – {JOB_TYPES.MANUAL.label} ({DRIVERS_INFO['עלי'].vehicle})</span>
          </div>
          <div className="flex items-center gap-2">
            <div className={`w-3 h-3 rounded-full bg-${DRIVERS_INFO['חכמת'].color}`}></div>
            <span>{DRIVERS_INFO['חכמת'].name} – {JOB_TYPES.CRANE.label} ({DRIVERS_INFO['חכמת'].vehicle})</span>
          </div>
          <div className="ms-auto text-white/60">חלון עבודה: {U.fmtTime(DAY_START_MIN)}–{U.fmtTime(DAY_END_MIN)}</div>
        </div>

        {/* Time header */}
        <div className="grid grid-cols-timeline gap-2 text-sm text-white/70 font-semibold">
          <div className=""></div> {/* Empty corner for alignment */}
          {Array.from({ length: (DAY_END_MIN - DAY_START_MIN) / 30 + 1 }).map((_, i) => {
            const time = DAY_START_MIN + i * 30;
            return (
              <div key={time} className="relative text-center">
                <div className="tick absolute inset-0"></div>
                <div className="relative z-10">{U.fmtTime(time)}</div>
              </div>
            );
          })}
        </div>

        {/* Ali lane */}
        <div className="relative mt-2">
          <div className="grid grid-cols-timeline gap-2">
            <div className="text-lg text-white font-medium flex items-center gap-2">👨‍🔧 {DRIVERS_INFO['עלי'].name}</div>
            {Array.from({ length: (DAY_END_MIN - DAY_START_MIN) / 30 + 1 }).map((_, i) => (
              <div key={`ali-tick-${i}`} className="h-3 relative"><div className="tick absolute inset-0"></div></div>
            ))}
          </div>
          <div ref={laneRefs.ALI} id="laneAli" className="relative h-24 mt-1 border border-dark-border rounded-2xl overflow-hidden bg-dark-card-bg">
            {todayOrders.filter(o => o.driverName === DRIVERS_INFO['עלי'].name).map(order => {
              const { left, width } = getOrderPosition(order);
              const bgColor = `bg-${DRIVERS_INFO['עלי'].color}/80`;
              return (
                <div
                  key={order.id}
                  className={`order-block ${bgColor} border border-dark-border shadow hover:shadow-neon`}
                  style={{ left, width }}
                  onMouseDown={(e) => handleDrag(e, order.id, 'ALI')}
                  onTouchStart={(e) => handleDrag(e, order.id, 'ALI')}
                >
                  <div className='p-2 text-sm leading-5'>
                    <div className='font-semibold text-white'>{order.customerName} · {order.city}</div>
                    <div className='text-white/90'>{order.time} → ETA {order.arriveHHMM} · סיום {order.finishHHMM}</div>
                    <div className='text-white/80'>{order.status || 'מתוכנן'}</div>
                  </div>
                   {/* Resizer handle */}
                   <div
                    className="absolute top-0 bottom-0 w-3 cursor-ew-resize bg-white/20 right-0 rounded-r-xl hover:bg-white/30 transition-colors"
                    onMouseDown={(e) => handleResize(e, order.id, 'ALI')}
                    onTouchStart={(e) => handleResize(e, order.id, 'ALI')}
                  ></div>
                </div>
              );
            })}
          </div>
        </div>

        {/* Hikmat lane */}
        <div className="relative mt-4">
          <div className="grid grid-cols-timeline gap-2">
            <div className="text-lg text-white font-medium flex items-center gap-2">🏗️ {DRIVERS_INFO['חכמת'].name}</div>
            {Array.from({ length: (DAY_END_MIN - DAY_START_MIN) / 30 + 1 }).map((_, i) => (
              <div key={`hikmat-tick-${i}`} className="h-3 relative"><div className="tick absolute inset-0"></div></div>
            ))}
          </div>
          <div ref={laneRefs.HIKMAT} id="laneHikmat" className="relative h-24 mt-1 border border-dark-border rounded-2xl overflow-hidden bg-dark-card-bg">
            {todayOrders.filter(o => o.driverName === DRIVERS_INFO['חכמת'].name).map(order => {
              const { left, width } = getOrderPosition(order);
              const bgColor = `bg-${DRIVERS_INFO['חכמת'].color}/80`;
              return (
                <div
                  key={order.id}
                  className={`order-block ${bgColor} border border-dark-border shadow hover:shadow-neon`}
                  style={{ left, width }}
                  onMouseDown={(e) => handleDrag(e, order.id, 'HIKMAT')}
                  onTouchStart={(e) => handleDrag(e, order.id, 'HIKMAT')}
                >
                  <div className='p-2 text-sm leading-5'>
                    <div className='font-semibold text-white'>{order.customerName} · {order.city}</div>
                    <div className='text-white/90'>{order.time} → ETA {order.arriveHHMM} · סיום {order.finishHHMM}</div>
                    <div className='text-white/80'>{order.status || 'מתוכנן'}</div>
                  </div>
                  {/* Resizer handle */}
                  <div
                    className="absolute top-0 bottom-0 w-3 cursor-ew-resize bg-white/20 right-0 rounded-r-xl hover:bg-white/30 transition-colors"
                    onMouseDown={(e) => handleResize(e, order.id, 'HIKMAT')}
                    onTouchStart={(e) => handleResize(e, order.id, 'HIKMAT')}
                  ></div>
                </div>
              );
            })}
          </div>
        </div>
      </div>
    </section>
  );
};


// --- Main Dashboard Component ---
const MainDashboard = ({ orders, isLoading, showDriverPage, onAddOrder, onEditOrder, onDeleteOrder }) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [driverFilter, setDriverFilter] = useState('');
  const [statusFilter, setStatusFilter] = useState('');
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingOrder, setEditingOrder] = useState(null);
  const [isAlertOpen, setIsAlertOpen] = useState(false);
  const [alertMessage, setAlertMessage] = useState('');

  const filteredOrders = orders.filter(order => {
    const matchesSearch = Object.values(order).some(value =>
      String(value).toLowerCase().includes(searchTerm.toLowerCase())
    );
    const matchesDriver = driverFilter === '' || order.driverName === driverFilter;
    const matchesStatus = statusFilter === '' || order.status === statusFilter;
    return matchesSearch && matchesDriver && matchesStatus;
  });

  const totalOrders = orders.length;
  const aliOrders = orders.filter(item => item.driverName === DRIVERS_INFO['עלי'].name).length;
  const hakmatOrders = orders.filter(item => item.driverName === DRIVERS_INFO['חכמת'].name).length;

  const handleOpenModal = (order = null) => {
    setEditingOrder(order);
    setIsModalOpen(true);
  };

  const handleCloseModal = () => {
    setIsModalOpen(false);
    setEditingOrder(null);
  };

  const handleOrderSubmit = (formData) => {
    const driverInfo = DRIVERS_INFO[formData.driverName];
    const jobType = formData.orderType.includes('מנוף') ? 'CRANE' : 'MANUAL';
    const { km, travelMin, serviceMin, arriveHHMM, finishHHMM } = calcETA({
      driver: driverInfo.id,
      jobType: jobType,
      city: formData.city,
      startHHMM: formData.time
    });

    const orderData = {
      ...formData,
      jobType,
      km,
      travelMin,
      serviceMin,
      arriveHHMM,
      finishHHMM
    };

    if (editingOrder) {
      onEditOrder({ ...editingOrder, ...orderData });
      setAlertMessage('הזמנה עודכנה בהצלחה!');
    } else {
      onAddOrder({ ...orderData, id: U.uid() });
      setAlertMessage('הזמנה נוספה בהצלחה!');
    }
    setIsAlertOpen(true);
  };

  const handleDelete = (orderId) => {
    setAlertMessage('האם אתה בטוח שברצונך למחוק הזמנה זו?');
    setIsAlertOpen(true);
    onDeleteOrder(orderId);
  };

  // Function to update order for timeline drag/resize
  const updateOrderFromTimeline = (orderId, newFields) => {
    const orderToUpdate = orders.find(o => o.id === orderId);
    if (orderToUpdate) {
      const updatedOrder = { ...orderToUpdate, ...newFields };
      // Recalculate ETA fields if time or serviceMin changed
      if (newFields.time || newFields.serviceMin) {
        const driverInfo = DRIVERS_INFO[updatedOrder.driverName];
        const jobType = updatedOrder.jobType;
        const etaData = calcETA({
          driver: driverInfo.id,
          jobType: jobType,
          city: updatedOrder.city,
          startHHMM: updatedOrder.time,
        });
        Object.assign(updatedOrder, etaData);
      }
      onEditOrder(updatedOrder);
      setAlertMessage(`הזמנה ${updatedOrder.customerName} עודכנה בהצלחה!`);
      setIsAlertOpen(true);
    }
  };


  return (
    <div id="main-dashboard-section" className="p-4 md:p-8 text-white">
      <header className="text-center mb-8 md:mb-12">
        <h1 className="text-4xl md:text-5xl font-extrabold text-white">מערכת ניהול נהגים - Dashboard</h1>
        <p className="mt-2 text-lg md:text-xl text-white/70">ניהול סידורים בזמן אמת עבור עלי וחכמת</p>
      </header>

      {isLoading && <LoadingSpinner />}

      <section id="dashboard-cards" className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8 md:mb-12">
        <div className="glass rounded-xl p-4 md:p-6 shadow-glow"> {/* Added shadow-glow here */}
          <h3 className="text-white/70 text-base font-medium">סה"כ הזמנות</h3>
          <p id="totalOrders" className="mt-1 text-3xl md:text-4xl font-semibold text-white">{totalOrders}</p>
        </div>
        <div onClick={() => showDriverPage('עלי')} className="glass rounded-xl p-4 md:p-6 cursor-pointer shadow-glow"> {/* Added shadow-glow here */}
          <h3 className="text-white/70 text-base font-medium">סידורים של עלי</h3>
          <p id="aliOrders" className="mt-1 text-3xl md:text-4xl font-semibold text-manual">{aliOrders}</p>
        </div>
        <div onClick={() => showDriverPage('חכמת')} className="glass rounded-xl p-4 md:p-6 cursor-pointer shadow-glow"> {/* Added shadow-glow here */}
          <h3 className="text-white/70 text-base font-medium">סידורים של חכמת</h3>
          <p id="hakmatOrders" className="mt-1 text-3xl md:text-4xl font-semibold text-crane">{hakmatOrders}</p>
        </div>
        <div className="bg-blue-600 text-white rounded-xl p-4 md:p-6 border border-blue-400 transition-transform transform hover:scale-105 flex items-center justify-center cursor-pointer hover:bg-blue-700 shadow-neon" onClick={() => handleOpenModal()}>
          <div className="text-center">
            <svg className="h-8 w-8 md:h-10 md:w-10 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"></path></svg>
            <p className="mt-2 font-bold text-lg md:text-xl">הוסף הזמנה חדשה</p>
          </div>
        </div>
      </section>

      {/* Timeline Integration */}
      <Timeline orders={orders} onUpdateOrder={updateOrderFromTimeline} />

      <section className="bg-dark-card-bg rounded-xl p-4 md:p-6 shadow-glow overflow-x-auto mt-8"> {/* Added shadow-glow here */}
        <h2 className="text-2xl md:text-3xl font-bold text-white mb-4">טבלת סידורי עבודה</h2>
        <div className="flex flex-col md:flex-row justify-between items-center mb-4 space-y-4 md:space-y-0">
          <input
            type="text"
            placeholder="חיפוש..."
            className="w-full md:w-1/3 p-3 rounded-lg bg-dark-card-bg border border-dark-border focus:outline-none focus:ring-2 focus:ring-primary text-white text-base rtl-input"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
          />
          <select
            className="w-full md:w-1/4 p-3 rounded-lg bg-dark-card-bg border border-dark-border focus:outline-none focus:ring-2 focus:ring-primary text-white text-base"
            value={driverFilter}
            onChange={(e) => setDriverFilter(e.target.value)}
          >
            <option value="">כל הנהגים</option>
            <option value="עלי">עלי</option>
            <option value="חכמת">חכמת</option>
          </select>
          <select
            className="w-full md:w-1/4 p-3 rounded-lg bg-dark-card-bg border border-dark-border focus:outline-none focus:ring-2 focus:ring-primary text-white text-base"
            value={statusFilter}
            onChange={(e) => setStatusFilter(e.target.value)}
          >
            <option value="">כל הסטטוסים</option>
            {STATUSES.map(statusValue => (
              <option key={statusValue} value={statusValue}>{statusValue}</option>
            ))}
          </select>
        </div>
        <div className="overflow-x-auto">
          <table className="min-w-full divide-y divide-dark-border">
            <thead className="bg-white/10">
              <tr>
                <th className="p-3 text-right text-sm font-medium text-white/70 uppercase tracking-wider">נהג</th>
                <th className="p-3 text-right text-sm font-medium text-white/70 uppercase tracking-wider">תאריך</th>
                <th className="p-3 text-right text-sm font-medium text-white/70 uppercase tracking-wider">שעה</th>
                <th className="p-3 text-right text-sm font-medium text-white/70 uppercase tracking-wider">מחסן</th>
                <th className="p-3 text-right text-sm font-medium text-white/70 uppercase tracking-wider">סטטוס</th>
                <th className="p-3 text-right text-sm font-medium text-white/70 uppercase tracking-wider">לקוח</th>
                <th className="p-3 text-right text-sm font-medium text-white/70 uppercase tracking-wider">כתובת אספקה</th>
                <th className="p-3 text-right text-sm font-medium text-white/70 uppercase tracking-wider">סוג פעולה</th>
                <th className="p-3 text-right text-sm font-medium text-white/70 uppercase tracking-wider">פעולות</th>
              </tr>
            </thead>
            <tbody id="ordersTableBody" className="divide-y divide-dark-border">
              {filteredOrders.map(order => (
                <TableRow
                  key={order.id}
                  order={order}
                  onEdit={() => handleOpenModal(order)}
                  onDelete={() => handleDelete(order.id)}
                />
              ))}
            </tbody>
          </table>
        </div>
      </section>

      <OrderModal
        isOpen={isModalOpen}
        onClose={handleCloseModal}
        onSubmit={handleOrderSubmit}
        initialData={editingOrder || {}}
      />
      {isAlertOpen && <CustomAlert message={alertMessage} onClose={() => setIsAlertOpen(false)} />}
    </div>
  );
};

// --- Driver Profile Page Component ---
const DriverPage = ({ driverName, orders, showMainDashboard, onEditOrder, onDeleteOrder }) => {
  const driverInfo = DRIVERS_INFO[driverName];
  if (!driverInfo) {
    return (
      <div className="text-center p-8 text-white">
        <p className="text-xl text-red-500">נהג לא נמצא</p>
        <button onClick={showMainDashboard} className="mt-4 px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition-colors">חזור ללוח המחוונים</button>
      </div>
    );
  }

  const driverOrders = orders.filter(item => item.driverName === driverName);

  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingOrder, setEditingOrder] = useState(null);
  const [isAlertOpen, setIsAlertOpen] = useState(false);
  const [alertMessage, setAlertMessage] = useState('');

  const handleOpenModal = (order) => {
    setEditingOrder(order);
    setIsModalOpen(true);
  };

  const handleCloseModal = () => {
    setIsModalOpen(false);
    setEditingOrder(null);
  };

  const handleOrderSubmit = (formData) => {
    const driver = DRIVERS_INFO[formData.driverName].id;
    const jobType = formData.orderType.includes('מנוף') ? 'CRANE' : 'MANUAL';
    const { km, travelMin, serviceMin, arriveHHMM, finishHHMM } = calcETA({
      driver,
      jobType,
      city: formData.city,
      startHHMM: formData.time
    });

    const orderData = {
      ...formData,
      jobType,
      km,
      travelMin,
      serviceMin,
      arriveHHMM,
      finishHHMM
    };

    onEditOrder({ ...editingOrder, ...orderData });
    setAlertMessage('הזמנה עודכנה בהצלחה!');
    setIsAlertOpen(true);
  };

  const handleDelete = (orderId) => {
    setAlertMessage('האם אתה בטוח שברצונך למחוק הזמנה זו?');
    setIsAlertOpen(true);
    onDeleteOrder(orderId);
  };

  return (
    <div id="driver-profile-section" className="p-4 md:p-8 text-white">
      <header className="text-center mb-8">
        <button onClick={showMainDashboard} className="mb-4 px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition-colors">חזור ללוח המחוונים</button>
        <img className="w-24 h-24 md:w-32 md:h-32 rounded-full mx-auto mb-4 container-shadow object-cover border border-dark-border" src={driverInfo.image} alt="Driver Profile Picture" />
        <h1 className="text-3xl md:text-4xl font-extrabold text-white">{driverInfo.name}</h1>
        <h2 className="mt-2 text-md md:text-lg text-white/70">{driverInfo.slogan}</h2>
      </header>
      <section className="bg-dark-card-bg rounded-xl p-4 md:p-6 shadow-glow overflow-x-auto"> {/* Added shadow-glow here */}
        <h3 className="text-2xl md:text-3xl font-bold text-white mb-4">טבלת הזמנות של {driverInfo.name}</h3>
        <div className="overflow-x-auto">
          <table className="min-w-full divide-y divide-dark-border">
            <thead className="bg-white/10">
              <tr>
                <th className="p-3 text-right text-sm font-medium text-white/70 uppercase tracking-wider">תאריך</th>
                <th className="p-3 text-right text-sm font-medium text-white/70 uppercase tracking-wider">שעה</th>
                <th className="p-3 text-right text-sm font-medium text-white/70 uppercase tracking-wider">מחסן</th>
                <th className="p-3 text-right text-sm font-medium text-white/70 uppercase tracking-wider">סטטוס</th>
                <th className="p-3 text-right text-sm font-medium text-white/70 uppercase tracking-wider">לקוח</th>
                <th className="p-3 text-right text-sm font-medium text-white/70 uppercase tracking-wider">כתובת אספקה</th>
                <th className="p-3 text-right text-sm font-medium text-white/70 uppercase tracking-wider">סוג פעולה</th>
                <th className="p-3 text-right text-sm font-medium text-white/70 uppercase tracking-wider">פעולות</th>
              </tr>
            </thead>
            <tbody id="driverOrdersTableBody" className="divide-y divide-dark-border">
              {driverOrders.map(order => (
                <TableRow
                  key={order.id}
                  order={order}
                  isDriverPage={true}
                  onEdit={() => handleOpenModal(order)}
                  onDelete={() => handleDelete(order.id)}
                />
              ))}
            </tbody>
          </table>
        </div>
      </section>

      <OrderModal
        isOpen={isModalOpen}
        onClose={handleCloseModal}
        onSubmit={handleOrderSubmit}
        initialData={editingOrder || {}}
      />
      {isAlertOpen && <CustomAlert message={alertMessage} onClose={() => setIsAlertOpen(false)} />}
    </div>
  );
};


// --- Main App Component ---
const App = () => {
  const [currentPage, setCurrentPage] = useState('dashboard'); // 'dashboard', 'עלי', 'חכמת'
  const [orders, setOrders] = useState([]);
  const [isLoading, setIsLoading] = useState(true);

  // Fetch orders on component mount
  useEffect(() => {
    const loadOrders = async () => {
      setIsLoading(true);
      const fetchedOrders = await fetchOrdersFromSheet();
      setOrders(fetchedOrders);
      setIsLoading(false);
    };
    loadOrders();
  }, []); // Empty dependency array means this runs once on mount

  const handleAddOrder = (newOrder) => {
    setOrders(prevOrders => [...prevOrders, newOrder]);
    // Optionally, send to Google Sheets via Apps Script
    // callApi('addOrder', newOrder);
  };

  const handleEditOrder = (updatedOrder) => {
    setOrders(prevOrders =>
      prevOrders.map(order => (order.id === updatedOrder.id ? updatedOrder : order))
    );
    // Optionally, send to Google Sheets via Apps Script
    // callApi('updateOrder', updatedOrder);
  };

  const handleDeleteOrder = (orderId) => {
    setOrders(prevOrders => prevOrders.filter(order => order.id !== orderId));
    // Optionally, send to Google Sheets via Apps Script
    // callApi('deleteOrder', { id: orderId });
  };

  const renderPage = () => {
    switch (currentPage) {
      case 'dashboard':
        return (
          <MainDashboard
            orders={orders}
            isLoading={isLoading}
            showDriverPage={setCurrentPage}
            onAddOrder={handleAddOrder}
            onEditOrder={handleEditOrder}
            onDeleteOrder={handleDeleteOrder}
          />
        );
      case 'עלי':
        return (
          <DriverPage
            driverName="עלי"
            orders={orders}
            showMainDashboard={() => setCurrentPage('dashboard')}
            onEditOrder={handleEditOrder}
            onDeleteOrder={handleDeleteOrder}
          />
        );
      case 'חכמת':
        return (
          <DriverPage
            driverName="חכמת"
            orders={orders}
            showMainDashboard={() => setCurrentPage('dashboard')}
            onEditOrder={handleEditOrder}
            onDeleteOrder={handleDeleteOrder}
          />
        );
      default:
        return (
          <MainDashboard
            orders={orders}
            isLoading={isLoading}
            showDriverPage={setCurrentPage}
            onAddOrder={handleAddOrder}
            onEditOrder={handleEditOrder}
            onDeleteOrder={handleDeleteOrder}
          />
        );
    }
  };

  return (
    <div className="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 bg-background min-h-screen rtl font-sans">
      {renderPage()}
    </div>
  );
};

export default App;
