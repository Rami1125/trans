<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מתורגמן חכם - עובד-מנהל</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    </style>

    <!-- simple-keyboard CSS CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/css/index.css">

    <style>
        /* הגדרות פונט וריסט כללי */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* הסתרת נגן האודיו המובנה של הדפדפן */
        audio {
            display: none;
        }

        /* סגנונות ספציפיים ל-simple-keyboard כדי להתאים ל-Tailwind */
        .simple-keyboard {
            @apply bg-white rounded-lg shadow-lg p-4 max-w-4xl mx-auto;
        }
        .simple-keyboard .hg-button {
            @apply rounded-md text-lg font-medium text-gray-800 bg-gray-100 hover:bg-gray-200 active:bg-gray-300;
            padding: 0.8rem 0.5rem; /* התאמה עדינה לגובה הכפתורים */
        }
        .simple-keyboard .hg-button.hg-standardBtn {
            @apply h-14; /* גובה קבוע לכפתורים רגילים */
        }
        .simple-keyboard .hg-button.hg-functionBtn {
            @apply bg-blue-500 text-white hover:bg-blue-600;
        }
        .simple-keyboard .hg-button.hg-button-space {
            @apply w-full;
        }
        .simple-keyboard .hg-button.hg-button-shift,
        .simple-keyboard .hg-button.hg-button-capslock,
        .simple-keyboard .hg-button.hg-button-tab,
        .simple-keyboard .hg-button.hg-button-bksp {
            @apply bg-gray-300 text-gray-800 hover:bg-gray-400;
        }
        .simple-keyboard .hg-button.hg-button-shift:active,
        .simple-keyboard .hg-button.hg-button-capslock:active {
            @apply bg-gray-500;
        }

        /* התאמה עדינה של כפתורי המקלדת (ספציפית לעברית/תאית) */
        .simple-keyboard .hg-row .hg-button {
            line-height: normal; /* וודא שהטקסט בתוך הכפתור לא נחתך */
        }

        /* התאמה לרספונסיביות של המקלדת */
        @media (max-width: 768px) {
            .simple-keyboard .hg-button {
                font-size: 0.9em;
                padding: 0.5rem 0.3rem;
            }
            .simple-keyboard .hg-button.hg-standardBtn {
                height: 3.5rem; /* גובה קטן יותר למסכים קטנים */
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6 space-y-8">

    <div class="w-full max-w-7xl flex flex-wrap lg:flex-nowrap justify-center gap-8">
        <!-- פאנל עובד תאילנדי -->
        <div class="bg-white rounded-2xl shadow-xl p-8 flex-1 flex flex-col items-center min-w-[320px] lg:min-w-[45%]">
            <h2 class="text-3xl font-bold text-green-700 mb-6">עובד תאילנדי (בקשות למנהל)</h2>
            <div id="thaiWorkerPanel" class="grid grid-cols-2 md:grid-cols-3 gap-5 w-full">
                <!-- כפתורים ייווצרו כאן ע"י JavaScript -->
            </div>
        </div>

        <!-- פאנל מנהל -->
        <div class="bg-white rounded-2xl shadow-xl p-8 flex-1 flex flex-col items-center min-w-[320px] lg:min-w-[45%]">
            <h2 class="text-3xl font-bold text-blue-700 mb-6">מנהל (הוראות לעובד)</h2>
            <div id="managerPanel" class="grid grid-cols-2 md:grid-cols-3 gap-5 w-full">
                <!-- כפתורים ייווצרו כאן ע"י JavaScript -->
            </div>
        </div>
    </div>

    <!-- פאנל תרגום וכתיבה חופשית -->
    <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-7xl flex flex-col items-center">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">תרגום וכתיבה חופשית</h2>
        <textarea id="freeTextInput" placeholder="הקלד כאן טקסט בעברית או בתאית..." rows="4"
                  class="w-full p-4 mb-6 text-xl border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition-all resize-y shadow-sm"></textarea>
        <div class="flex flex-wrap justify-center gap-4 mb-8 w-full">
            <button id="setLangHe" class="px-8 py-4 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition-all text-xl">
                הקלד בעברית
            </button>
            <button id="setLangTh" class="px-8 py-4 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition-all text-xl thai-text">
                พิมพ์ภาษาไทย
            </button>
            <button id="speakTranslated" class="px-8 py-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-all text-xl">
                השמע טקסט מתורגם
            </button>
        </div>
        <div class="simple-keyboard w-full"></div>
    </div>

    <!-- simple-keyboard JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/index.js"></script>

    <script>
        // נתיב לתיקיית קבצי האודיו עבור המשפטים הקבועים
        const audioPath = 'audio/';
        let currentAudio = null; // משתנה לשמירה על נגן האודיו הנוכחי
        // כתובת שרת הפלאסק שלך - וודא שהשרת רץ על פורט 5000
        const SERVER_URL = 'http://localhost:5000';

        // הגדרות מקלדת וירטואלית SimpleKeyboard
        let keyboard;
        let currentKeyboardLayout = 'hebrew'; // ברירת מחדל: עברית

        // פריסות מקלדת עבור עברית ותאית (פריסות אלו הן דוגמאות בסיסיות ויתכן שיש צורך להתאים אותן במדויק.)
        const layoutOptions = {
            'hebrew': {
                default: [
                    "` 1 2 3 4 5 6 7 8 9 0 - = {bksp}",
                    "{tab} / ' ק ר ו ן ט צ ש ד ג כ ע ח י ל ף ,",
                    "{capslock} ז ס ב ה נ מ ך ף , . / \\",
                    "{shift} ת א ד ה ב ג ו ח ז ל ט ר נ מ {shift}",
                    "{space}"
                ],
                shift: [
                    "~ ! @ # $ % ^ & * ( ) _ + {bksp}",
                    "{tab} Q W E R T Y U I O P { } |",
                    "{capslock} A S D F G H J K L : \"",
                    "{shift} Z X C V B N M < > ? {shift}",
                    "{space}"
                ]
            },
            'thai': {
                default: [
                    "ๅ / - ภ ถุ ู กึ หิ ่ ้ ็ ื {bksp}",
                    "{tab} พั รน ะ ตร ยบ ุย อิ โ โอ ป ก ฬ",
                    "{capslock} า ส ด ฟ แ ะั ห โ ค ช",
                    "{shift} ซษ มอ ดบ น เ ท จ ก ็ {shift}",
                    "{space}"
                ],
                shift: [
                    "+ ๑ ๒ ๓ ๔ ๕ ๖ ๗ ๘ ๙ ๐ ฯ ญ ฏ {bksp}",
                    "{tab} ฎ ฑ ธ ํ ๊ ณ ม ย ณบ ุุ ณข ณค ณง {tab}",
                    "{capslock} ฟะ หะ กะ ดะ สั ะั น ะร ะล ะอ ะใ {capslock}",
                    "{shift} ะม ะน ะว ะอ ะร ะส ะฟ ะง ะจ ะค ะล {shift}",
                    "{space}"
                ]
            }
        };


        // פונקציה לטעינת נתוני המשפטים מקובץ JSON
        // יש לשמור את קובץ phrases.json באותה תיקייה כמו index.html
        async function loadPhrases() {
            try {
                const response = await fetch('phrases.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const phrases = await response.json();
                renderButtons(phrases);
            } catch (error) {
                console.error("שגיאה בטעינת המשפטים:", error);
                document.getElementById('thaiWorkerPanel').innerHTML = `<p class="text-red-500">שגיאה בטעינת נתונים. נסה לרענן את הדף. ${error.message}</p>`;
                document.getElementById('managerPanel').innerHTML = `<p class="text-red-500">שגיאה בטעינת נתונים. נסה לרענן את הדף. ${error.message}</p>`;
            }
        }

        // פונקציה ליצירת כפתורים והצגתם בפאנלים המתאימים
        function renderButtons(phrases) {
            const thaiWorkerPanel = document.getElementById('thaiWorkerPanel');
            const managerPanel = document.getElementById('managerPanel');

            phrases.forEach(phrase => {
                const button = document.createElement('button');
                // Tailwind classes for consistent button styling
                button.classList.add(
                    'flex', 'items-center', 'justify-center', 'px-4', 'py-4', 'rounded-xl', 'font-semibold',
                    'shadow-lg', 'hover:shadow-xl', 'transition-all', 'duration-200', 'active:scale-95',
                    'text-xl', 'text-white', 'text-center', 'min-h-[100px]'
                );

                if (phrase.panel === 'thai_worker') {
                    // לעובד תאילנדי: כפתור עם display_text, בלחיצה משמיע בעברית למנהל
                    button.textContent = phrase.display_text || phrase.he_text; // Fallback to full text if display_text is missing
                    button.onclick = () => playAudio(audioPath + phrase.he_audio_file);
                    button.classList.add('bg-green-600', 'hover:bg-green-700'); // צבע ירוק לעובד
                    thaiWorkerPanel.appendChild(button);
                } else if (phrase.panel === 'manager') {
                    // למנהל: כפתור עם display_text, בלחיצה משמיע בתאית לעובד
                    button.textContent = phrase.display_text || phrase.he_text; // Fallback to full text
                    button.onclick = () => playAudio(audioPath + phrase.th_audio_file);
                    button.classList.add('bg-blue-600', 'hover:bg-blue-700'); // צבע כחול למנהל
                    managerPanel.appendChild(button);
                }
            });
        }

        // פונקציה להשמעת קובץ אודיו
        function playAudio(audioFile) {
            // אם יש אודיו אחר שמתנגן, עצור אותו ואתחל אותו
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }

            // צור אובייקט Audio חדש והפעל אותו
            currentAudio = new Audio(audioFile);
            currentAudio.play().catch(e => console.error("שגיאה בהשמעת אודיו:", e));
        }

        // ----- לוגיקה עבור המקלדת והתרגום החופשי -----

        // אתחול המקלדת הווירטואלית
        function initKeyboard() {
            const freeTextInput = document.getElementById('freeTextInput');
            keyboard = new SimpleKeyboard.default({
                input: freeTextInput, // קושר את המקלדת לשדה הטקסט
                layout: layoutOptions[currentKeyboardLayout], // פריסת המקלדת הראשונית
                rtl: currentKeyboardLayout === 'hebrew', // הגדרת כיווניות (RTL לעברית)
                onChange: input => freeTextInput.value = input, // עדכון שדה הטקסט עם הקלדת המשתמש
                onKeyPress: button => onKeyPress(button), // פונקציה לטיפול בלחיצות מקשים
                theme: "hg-theme-default", // נושא עיצוב בסיסי של simple-keyboard
                display: {
                    '{bksp}': 'מחק',
                    '{tab}': 'טאב',
                    '{capslock}': 'Caps Lock',
                    '{shift}': 'Shift',
                    '{space}': 'רווח'
                }
            });

            // עדכון המקלדת כאשר משתמש מקליד ישירות לשדה הטקסט
            freeTextInput.addEventListener('input', event => {
                keyboard.setInput(event.target.value);
            });

            // הגדר כיוון טקסט התחלתי
            document.getElementById('freeTextInput').dir = currentKeyboardLayout === 'hebrew' ? 'rtl' : 'ltr';
        }

        // טיפול בלחיצות מקשים מיוחדים במקלדת
        function onKeyPress(button) {
            // עבור Shift או Caps Lock, החלף בין פריסות המקלדת (רגיל/Shift)
            if (button === "{shift}" || button === "{capslock}") {
                toggleShift();
            }
        }

        // החלפה בין מצב Shift למצב רגיל במקלדת
        function toggleShift() {
            let currentLayoutName = keyboard.options.layoutName;
            let newLayoutName = currentLayoutName === "default" ? "shift" : "default";
            keyboard.setOptions({ layoutName: newLayoutName });
        }

        // לחיצה על כפתור "הקלד בעברית"
        document.getElementById('setLangHe').addEventListener('click', () => {
            currentKeyboardLayout = 'hebrew';
            keyboard.setOptions({
                layout: layoutOptions['hebrew'],
                rtl: true
            });
            document.getElementById('freeTextInput').dir = 'rtl';
            keyboard.setInput(''); // נקה את שדה הטקסט בלחיצת מעבר שפה
        });

        // לחיצה על כפתור "พิมพ์ภาษาไทย" (הקלד בתאית)
        document.getElementById('setLangTh').addEventListener('click', () => {
            currentKeyboardLayout = 'thai';
            keyboard.setOptions({
                layout: layoutOptions['thai'],
                rtl: false
            });
            document.getElementById('freeTextInput').dir = 'ltr';
            keyboard.setInput(''); // נקה את שדה הטקסט בלחיצת מעבר שפה
        });

        // פונקציית תרגום והשמעה עבור טקסט חופשי (מתקשרת לשרת הפלאסק)
        document.getElementById('speakTranslated').addEventListener('click', async () => {
            const text = document.getElementById('freeTextInput').value.trim();
            if (!text) {
                alert("אנא הקלד טקסט לתרגום והשמעה.");
                return;
            }

            let sourceLang; // שפת המקור של הטקסט שנקלט
            let targetLang; // שפת היעד של התרגום וההשמעה

            // קביעת שפות המקור והיעד בהתבסס על פריסת המקלדת הנוכחית
            if (currentKeyboardLayout === 'hebrew') {
                sourceLang = 'he';
                targetLang = 'th'; // אם המשתמש כותב בעברית, נתרגם ונשמיע בתאית (לצורך העובד)
            } else {
                sourceLang = 'th';
                targetLang = 'he'; // אם המשתמש כותב בתאית, נתרגם ונשמיע בעברית (לצורך המנהל)
            }

            try {
                // שליחת הבקשה לשרת הפלאסק
                const response = await fetch(`${SERVER_URL}/translate_and_speak`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        source_lang: sourceLang,
                        target_lang: targetLang
                    })
                });

                if (!response.ok) {
                    // אם השרת החזיר שגיאה
                    const errorData = await response.json();
                    throw new Error(`שגיאת שרת: ${response.status} - ${errorData.error || 'שגיאה לא ידועה'}`);
                }

                // קבלת קובץ האודיו כ-Blob (נתונים בינאריים)
                const audioBlob = await response.blob();
                // יצירת URL זמני לאודיו מה-Blob
                const audioUrl = URL.createObjectURL(audioBlob);
                // השמעת האודיו
                playAudio(audioUrl);

            } catch (error) {
                console.error("שגיאה בתרגום או השמעה:", error);
                alert("שגיאה בתרגום או השמעה: " + error.message + "\nודא ששרת הפלאסק פועל.");
            }
        });

        // טען את המשפטים עם טעינת הדף ואתחל את המקלדת
        document.addEventListener('DOMContentLoaded', () => {
            loadPhrases();
            initKeyboard();
        });
    </script>

</body>
</html>
